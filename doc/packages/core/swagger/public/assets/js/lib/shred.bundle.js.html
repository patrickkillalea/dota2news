<!DOCTYPE html>
<html>
<head>
  <title>shred.bundle.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../../../doc-style.css" />
  <script src="../../../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../../../", thisFile = "packages/core/swagger/public/assets/js/lib/shred.bundle.js", defaultSidebar = true;
  </script>
  <script src="../../../../../../../doc-script.js"></script>
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs">
          <h1>shred.bundle.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1">&#182;</a>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">require</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">cwd</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">resolved</span> <span class="o">=</span> <span class="nx">require</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">cwd</span> <span class="o">||</span> <span class="s1">&#39;/&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">mod</span> <span class="o">=</span> <span class="nx">require</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">resolved</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">mod</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span>
        <span class="s1">&#39;Failed to resolve module &#39;</span> <span class="o">+</span> <span class="nx">file</span> <span class="o">+</span> <span class="s1">&#39;, tried &#39;</span> <span class="o">+</span> <span class="nx">resolved</span>
    <span class="p">);</span>
    <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">mod</span><span class="p">.</span><span class="nx">_cached</span> <span class="o">?</span> <span class="nx">mod</span><span class="p">.</span><span class="nx">_cached</span> <span class="o">:</span> <span class="nx">mod</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">require</span><span class="p">.</span><span class="nx">paths</span> <span class="o">=</span> <span class="p">[];</span>
<span class="nx">require</span><span class="p">.</span><span class="nx">modules</span> <span class="o">=</span> <span class="p">{};</span>
<span class="nx">require</span><span class="p">.</span><span class="nx">extensions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;.js&quot;</span><span class="p">,</span><span class="s2">&quot;.coffee&quot;</span><span class="p">];</span>

<span class="nx">require</span><span class="p">.</span><span class="nx">_core</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;assert&#39;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="s1">&#39;events&#39;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="s1">&#39;fs&#39;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="s1">&#39;path&#39;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="s1">&#39;vm&#39;</span><span class="o">:</span> <span class="kc">true</span>
<span class="p">};</span>

<span class="nx">require</span><span class="p">.</span><span class="nx">resolve</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">cwd</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">cwd</span><span class="p">)</span> <span class="nx">cwd</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="p">;</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="nx">require</span><span class="p">.</span><span class="nx">_core</span><span class="p">[</span><span class="nx">x</span><span class="p">])</span> <span class="k">return</span> <span class="nx">x</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">.</span><span class="nx">modules</span><span class="p">.</span><span class="nx">path</span><span class="p">();</span>
        <span class="kd">var</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">cwd</span> <span class="o">||</span> <span class="s1">&#39;.&#39;</span><span class="p">;</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^(?:\.\.?\/|\/)/</span><span class="p">))</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">loadAsFileSync</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">y</span><span class="p">,</span> <span class="nx">x</span><span class="p">))</span>
                <span class="o">||</span> <span class="nx">loadAsDirectorySync</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">y</span><span class="p">,</span> <span class="nx">x</span><span class="p">));</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">m</span><span class="p">)</span> <span class="k">return</span> <span class="nx">m</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">loadNodeModulesSync</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="k">return</span> <span class="nx">n</span><span class="p">;</span>
        
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Cannot find module &#39;&quot;</span> <span class="o">+</span> <span class="nx">x</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">);</span>
        
        <span class="kd">function</span> <span class="nx">loadAsFileSync</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">require</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">x</span><span class="p">])</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">x</span><span class="p">;</span>
            <span class="p">}</span>
            
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">require</span><span class="p">.</span><span class="nx">extensions</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">ext</span> <span class="o">=</span> <span class="nx">require</span><span class="p">.</span><span class="nx">extensions</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">require</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">ext</span><span class="p">])</span> <span class="k">return</span> <span class="nx">x</span> <span class="o">+</span> <span class="nx">ext</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="kd">function</span> <span class="nx">loadAsDirectorySync</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">x</span> <span class="o">=</span> <span class="nx">x</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/+$/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
            <span class="kd">var</span> <span class="nx">pkgfile</span> <span class="o">=</span> <span class="nx">x</span> <span class="o">+</span> <span class="s1">&#39;/package.json&#39;</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">require</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">pkgfile</span><span class="p">])</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">pkg</span> <span class="o">=</span> <span class="nx">require</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">pkgfile</span><span class="p">]();</span>
                <span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">pkg</span><span class="p">.</span><span class="nx">browserify</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">b</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">main</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">loadAsFileSync</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">b</span><span class="p">.</span><span class="nx">main</span><span class="p">));</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">m</span><span class="p">)</span> <span class="k">return</span> <span class="nx">m</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">b</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">loadAsFileSync</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">b</span><span class="p">));</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">m</span><span class="p">)</span> <span class="k">return</span> <span class="nx">m</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">pkg</span><span class="p">.</span><span class="nx">main</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">loadAsFileSync</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">pkg</span><span class="p">.</span><span class="nx">main</span><span class="p">));</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">m</span><span class="p">)</span> <span class="k">return</span> <span class="nx">m</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            
            <span class="k">return</span> <span class="nx">loadAsFileSync</span><span class="p">(</span><span class="nx">x</span> <span class="o">+</span> <span class="s1">&#39;/index&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        
        <span class="kd">function</span> <span class="nx">loadNodeModulesSync</span> <span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">start</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">dirs</span> <span class="o">=</span> <span class="nx">nodeModulesPathsSync</span><span class="p">(</span><span class="nx">start</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">dirs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">dir</span> <span class="o">=</span> <span class="nx">dirs</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                <span class="kd">var</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">loadAsFileSync</span><span class="p">(</span><span class="nx">dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">x</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">m</span><span class="p">)</span> <span class="k">return</span> <span class="nx">m</span><span class="p">;</span>
                <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">loadAsDirectorySync</span><span class="p">(</span><span class="nx">dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">x</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="k">return</span> <span class="nx">n</span><span class="p">;</span>
            <span class="p">}</span>
            
            <span class="kd">var</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">loadAsFileSync</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">m</span><span class="p">)</span> <span class="k">return</span> <span class="nx">m</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="kd">function</span> <span class="nx">nodeModulesPathsSync</span> <span class="p">(</span><span class="nx">start</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">parts</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">start</span> <span class="o">===</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="nx">parts</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;&#39;</span> <span class="p">];</span>
            <span class="k">else</span> <span class="nx">parts</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">normalize</span><span class="p">(</span><span class="nx">start</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
            
            <span class="kd">var</span> <span class="nx">dirs</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">parts</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;node_modules&#39;</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
                <span class="kd">var</span> <span class="nx">dir</span> <span class="o">=</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/node_modules&#39;</span><span class="p">;</span>
                <span class="nx">dirs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">dir</span><span class="p">);</span>
            <span class="p">}</span>
            
            <span class="k">return</span> <span class="nx">dirs</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">};</span>
<span class="p">})();</span>

<span class="nx">require</span><span class="p">.</span><span class="nx">alias</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">.</span><span class="nx">modules</span><span class="p">.</span><span class="nx">path</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="nx">res</span> <span class="o">=</span> <span class="nx">require</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">from</span> <span class="o">+</span> <span class="s1">&#39;/package.json&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span> <span class="o">=</span> <span class="nx">require</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">basedir</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
    
    <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span> <span class="o">||</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">)</span> <span class="nx">res</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">;</span>
    <span class="p">})(</span><span class="nx">require</span><span class="p">.</span><span class="nx">modules</span><span class="p">);</span>
    
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">key</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">basedir</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">===</span> <span class="nx">basedir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">key</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">basedir</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
            <span class="nx">require</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">to</span> <span class="o">+</span> <span class="nx">f</span><span class="p">]</span> <span class="o">=</span> <span class="nx">require</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">basedir</span> <span class="o">+</span> <span class="nx">f</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">key</span> <span class="o">===</span> <span class="nx">basedir</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">require</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">to</span><span class="p">]</span> <span class="o">=</span> <span class="nx">require</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">basedir</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="nx">require</span><span class="p">.</span><span class="nx">define</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">filename</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">dirname</span> <span class="o">=</span> <span class="nx">require</span><span class="p">.</span><span class="nx">_core</span><span class="p">[</span><span class="nx">filename</span><span class="p">]</span>
        <span class="o">?</span> <span class="s1">&#39;&#39;</span>
        <span class="o">:</span> <span class="nx">require</span><span class="p">.</span><span class="nx">modules</span><span class="p">.</span><span class="nx">path</span><span class="p">().</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span>
    <span class="p">;</span>
    
    <span class="kd">var</span> <span class="nx">require_</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">require</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">dirname</span><span class="p">)</span>
    <span class="p">};</span>
    <span class="nx">require_</span><span class="p">.</span><span class="nx">resolve</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">require</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">dirname</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="nx">require_</span><span class="p">.</span><span class="nx">modules</span> <span class="o">=</span> <span class="nx">require</span><span class="p">.</span><span class="nx">modules</span><span class="p">;</span>
    <span class="nx">require_</span><span class="p">.</span><span class="nx">define</span> <span class="o">=</span> <span class="nx">require</span><span class="p">.</span><span class="nx">define</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">module_</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">exports</span> <span class="o">:</span> <span class="p">{}</span> <span class="p">};</span>
    
    <span class="nx">require</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">filename</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">require</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">filename</span><span class="p">].</span><span class="nx">_cached</span> <span class="o">=</span> <span class="nx">module_</span><span class="p">.</span><span class="nx">exports</span><span class="p">;</span>
        <span class="nx">fn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span>
            <span class="nx">module_</span><span class="p">.</span><span class="nx">exports</span><span class="p">,</span>
            <span class="nx">require_</span><span class="p">,</span>
            <span class="nx">module_</span><span class="p">,</span>
            <span class="nx">module_</span><span class="p">.</span><span class="nx">exports</span><span class="p">,</span>
            <span class="nx">dirname</span><span class="p">,</span>
            <span class="nx">filename</span>
        <span class="p">);</span>
        <span class="nx">require</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">filename</span><span class="p">].</span><span class="nx">_cached</span> <span class="o">=</span> <span class="nx">module_</span><span class="p">.</span><span class="nx">exports</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">module_</span><span class="p">.</span><span class="nx">exports</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">};</span>

<span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">process</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="nx">process</span> <span class="o">=</span> <span class="p">{};</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">)</span> <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">queue</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="kd">var</span> <span class="nx">canPost</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nb">window</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span>
        <span class="o">&amp;&amp;</span> <span class="nb">window</span><span class="p">.</span><span class="nx">postMessage</span> <span class="o">&amp;&amp;</span> <span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span>
    <span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nx">canPost</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">source</span> <span class="o">===</span> <span class="nb">window</span> <span class="o">&amp;&amp;</span> <span class="nx">ev</span><span class="p">.</span><span class="nx">data</span> <span class="o">===</span> <span class="s1">&#39;browserify-tick&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">ev</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">();</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">queue</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">fn</span> <span class="o">=</span> <span class="nx">queue</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
                    <span class="nx">fn</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">},</span> <span class="kc">true</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">canPost</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">queue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">fn</span><span class="p">);</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">(</span><span class="s1">&#39;browserify-tick&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">};</span>
<span class="p">})();</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">process</span><span class="p">.</span><span class="nx">title</span><span class="p">)</span> <span class="nx">process</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="s1">&#39;browser&#39;</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">process</span><span class="p">.</span><span class="nx">binding</span><span class="p">)</span> <span class="nx">process</span><span class="p">.</span><span class="nx">binding</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">name</span> <span class="o">===</span> <span class="s1">&#39;evals&#39;</span><span class="p">)</span> <span class="k">return</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;vm&#39;</span><span class="p">)</span>
    <span class="k">else</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;No such module&#39;</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">process</span><span class="p">.</span><span class="nx">cwd</span><span class="p">)</span> <span class="nx">process</span><span class="p">.</span><span class="nx">cwd</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="s1">&#39;.&#39;</span> <span class="p">};</span>

<span class="nx">require</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span> <span class="nx">exports</span><span class="p">,</span> <span class="nx">__dirname</span><span class="p">,</span> <span class="nx">__filename</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">function</span> <span class="nx">filter</span> <span class="p">(</span><span class="nx">xs</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">xs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">fn</span><span class="p">(</span><span class="nx">xs</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">xs</span><span class="p">))</span> <span class="nx">res</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">xs</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">;</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2">&#182;</a>
</div>
<p>resolves . and .. elements in a path array with directory names there
must be no slashes, empty elements, or device names (c:) in the array
(so also no leading and trailing slashes - it does not distinguish
relative and absolute paths)</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">function</span> <span class="nx">normalizeArray</span><span class="p">(</span><span class="nx">parts</span><span class="p">,</span> <span class="nx">allowAboveRoot</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3">&#182;</a>
</div>
<p>if the path tries to go above the root, <code>up</code> ends up > 0</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">last</span> <span class="o">=</span> <span class="nx">parts</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">last</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">parts</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">last</span> <span class="o">===</span> <span class="s1">&#39;..&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">parts</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="nx">up</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">up</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">parts</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="nx">up</span><span class="o">--</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<p>if the path is allowed to go above the root, restore leading ..s</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">if</span> <span class="p">(</span><span class="nx">allowAboveRoot</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(;</span> <span class="nx">up</span><span class="o">--</span><span class="p">;</span> <span class="nx">up</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">parts</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">parts</span><span class="p">;</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<p>Regex to split a filename into [*, dir, basename, ext]
posix version</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">var</span> <span class="nx">splitPathRe</span> <span class="o">=</span> <span class="sr">/^(.+\/(?!$)|\/)?((?:.+?)?(\.[^.]*)?)$/</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6">&#182;</a>
</div>
<p>path.resolve([from ...], to)
posix version</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">exports</span><span class="p">.</span><span class="nx">resolve</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<span class="kd">var</span> <span class="nx">resolvedPath</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="nx">resolvedAbsolute</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">resolvedAbsolute</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
      <span class="o">?</span> <span class="nx">arguments</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
      <span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">cwd</span><span class="p">();</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7">&#182;</a>
</div>
<p>Skip empty and invalid entries</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">path</span> <span class="o">!==</span> <span class="s1">&#39;string&#39;</span> <span class="o">||</span> <span class="o">!</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">continue</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">resolvedPath</span> <span class="o">=</span> <span class="nx">path</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">resolvedPath</span><span class="p">;</span>
  <span class="nx">resolvedAbsolute</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;/&#39;</span><span class="p">;</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8">&#182;</a>
</div>
<p>At this point the path should be resolved to a full absolute path, but
handle relative paths to be safe (might happen when process.cwd() fails)</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9">&#182;</a>
</div>
<p>Normalize the path</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">resolvedPath</span> <span class="o">=</span> <span class="nx">normalizeArray</span><span class="p">(</span><span class="nx">filter</span><span class="p">(</span><span class="nx">resolvedPath</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">!!</span><span class="nx">p</span><span class="p">;</span>
  <span class="p">}),</span> <span class="o">!</span><span class="nx">resolvedAbsolute</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>

  <span class="k">return</span> <span class="p">((</span><span class="nx">resolvedAbsolute</span> <span class="o">?</span> <span class="s1">&#39;/&#39;</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nx">resolvedPath</span><span class="p">)</span> <span class="o">||</span> <span class="s1">&#39;.&#39;</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10">&#182;</a>
</div>
<p>path.normalize(path)
posix version</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">exports</span><span class="p">.</span><span class="nx">normalize</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
<span class="kd">var</span> <span class="nx">isAbsolute</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span>
    <span class="nx">trailingSlash</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;/&#39;</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11">&#182;</a>
</div>
<p>Normalize the path</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">path</span> <span class="o">=</span> <span class="nx">normalizeArray</span><span class="p">(</span><span class="nx">filter</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">!!</span><span class="nx">p</span><span class="p">;</span>
  <span class="p">}),</span> <span class="o">!</span><span class="nx">isAbsolute</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">path</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isAbsolute</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">path</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">path</span> <span class="o">&amp;&amp;</span> <span class="nx">trailingSlash</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">path</span> <span class="o">+=</span> <span class="s1">&#39;/&#39;</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="k">return</span> <span class="p">(</span><span class="nx">isAbsolute</span> <span class="o">?</span> <span class="s1">&#39;/&#39;</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nx">path</span><span class="p">;</span>
<span class="p">};</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12">&#182;</a>
</div>
<p>posix version</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">exports</span><span class="p">.</span><span class="nx">join</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">paths</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">normalize</span><span class="p">(</span><span class="nx">filter</span><span class="p">(</span><span class="nx">paths</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">p</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">p</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">;</span>
  <span class="p">}).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">));</span>
<span class="p">};</span>


<span class="nx">exports</span><span class="p">.</span><span class="nx">dirname</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">dir</span> <span class="o">=</span> <span class="nx">splitPathRe</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">isWindows</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">dir</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13">&#182;</a>
</div>
<p>No dirname</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">return</span> <span class="s1">&#39;.&#39;</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">dir</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">||</span>
      <span class="p">(</span><span class="nx">isWindows</span> <span class="o">&amp;&amp;</span> <span class="nx">dir</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="nx">dir</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;:&#39;</span><span class="p">))</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14">&#182;</a>
</div>
<p>It is just a slash or a drive letter with a slash</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">return</span> <span class="nx">dir</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15">&#182;</a>
</div>
<p>It is a full dirname, strip trailing slash</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">return</span> <span class="nx">dir</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">dir</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>


<span class="nx">exports</span><span class="p">.</span><span class="nx">basename</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">ext</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">splitPathRe</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">path</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16">&#182;</a>
</div>
<p>TODO: make this comparison case-insensitive on windows?</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">if</span> <span class="p">(</span><span class="nx">ext</span> <span class="o">&amp;&amp;</span> <span class="nx">f</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="nx">ext</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">===</span> <span class="nx">ext</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">f</span> <span class="o">=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">f</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">ext</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">f</span><span class="p">;</span>
<span class="p">};</span>


<span class="nx">exports</span><span class="p">.</span><span class="nx">extname</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">splitPathRe</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">path</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="p">};</span>

<span class="p">});</span>

<span class="nx">require</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s2">&quot;/shred.js&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span> <span class="nx">exports</span><span class="p">,</span> <span class="nx">__dirname</span><span class="p">,</span> <span class="nx">__filename</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17">&#182;</a>
</div>
<p>Shred is an HTTP client library intended to simplify the use of Node's
built-in HTTP library. In particular, we wanted to make it easier to interact
with HTTP-based APIs.</p>

<p>See the <a href="./examples.html">examples</a> for more details.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18">&#182;</a>
</div>
<p>Ax is a nice logging library we wrote. You can use any logger, providing it
has <code>info</code>, <code>warn</code>, <code>debug</code>, and <code>error</code> methods that take a string.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">var</span> <span class="nx">Ax</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;ax&quot;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">CookieJarLib</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span> <span class="s2">&quot;cookiejar&quot;</span> <span class="p">)</span>
  <span class="p">,</span> <span class="nx">CookieJar</span> <span class="o">=</span> <span class="nx">CookieJarLib</span><span class="p">.</span><span class="nx">CookieJar</span>
<span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19">&#182;</a>
</div>
<p>Shred takes some options, including a logger and request defaults.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="kd">var</span> <span class="nx">Shred</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">options</span> <span class="o">=</span> <span class="p">(</span><span class="nx">options</span><span class="o">||</span><span class="p">{});</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">agent</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">agent</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">defaults</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">defaults</span><span class="o">||</span><span class="p">{};</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">log</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">logger</span><span class="o">||</span><span class="p">(</span><span class="k">new</span> <span class="nx">Ax</span><span class="p">({</span> <span class="nx">level</span><span class="o">:</span> <span class="s2">&quot;info&quot;</span> <span class="p">}));</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_sharedCookieJar</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CookieJar</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">logCurl</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">logCurl</span> <span class="o">||</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20">&#182;</a>
</div>
<p>Most of the real work is done in the request and reponse classes.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
 
<span class="nx">Shred</span><span class="p">.</span><span class="nx">Request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./shred/request&quot;</span><span class="p">);</span>
<span class="nx">Shred</span><span class="p">.</span><span class="nx">Response</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./shred/response&quot;</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21">&#182;</a>
</div>
<p>The <code>request</code> method kicks off a new request, instantiating a new <code>Request</code>
object and passing along whatever default options we were given.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="nx">Shred</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">request</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">logger</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">;</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">logCurl</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">logCurl</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">logCurl</span><span class="p">;</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">cookieJar</span> <span class="o">=</span> <span class="p">(</span> <span class="s1">&#39;cookieJar&#39;</span> <span class="k">in</span> <span class="nx">options</span> <span class="p">)</span> <span class="o">?</span> <span class="nx">options</span><span class="p">.</span><span class="nx">cookieJar</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_sharedCookieJar</span><span class="p">;</span> <span class="c1">// let them set cookieJar = null</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">agent</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">agent</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">agent</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22">&#182;</a>
</div>
<p>fill in default options</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">defaults</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">options</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span> <span class="p">{</span>
        <span class="nx">options</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">defaults</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Shred</span><span class="p">.</span><span class="nx">Request</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23">&#182;</a>
</div>
<p>Define a bunch of convenience methods so that you don't have to include
a <code>method</code> property in your request options.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="s2">&quot;get put post delete&quot;</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">method</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">Shred</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">method</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="nx">method</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
  <span class="p">};</span>
<span class="p">});</span>


<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Shred</span><span class="p">;</span>

<span class="p">});</span>

<span class="nx">require</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s2">&quot;/node_modules/ax/package.json&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span> <span class="nx">exports</span><span class="p">,</span> <span class="nx">__dirname</span><span class="p">,</span> <span class="nx">__filename</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;main&quot;</span><span class="o">:</span><span class="s2">&quot;./lib/ax.js&quot;</span><span class="p">}</span>
<span class="p">});</span>

<span class="nx">require</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s2">&quot;/node_modules/ax/lib/ax.js&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span> <span class="nx">exports</span><span class="p">,</span> <span class="nx">__dirname</span><span class="p">,</span> <span class="nx">__filename</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">inspect</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;util&quot;</span><span class="p">).</span><span class="nx">inspect</span>
  <span class="p">,</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;fs&quot;</span><span class="p">)</span>
<span class="p">;</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24">&#182;</a>
</div>
<p>this is a quick-and-dirty logger. there are other nicer loggers out there
but the ones i found were also somewhat involved. this one has a Ruby
logger type interface</p>

<p>we can easily replace this, provide the info, debug, etc. methods are the
same. or, we can change Haiku to use a more standard node.js interface</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="kd">var</span> <span class="nx">format</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">level</span><span class="p">,</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">debug</span> <span class="o">=</span> <span class="p">(</span><span class="nx">level</span><span class="o">==</span><span class="s2">&quot;debug&quot;</span><span class="o">||</span><span class="nx">level</span><span class="o">==</span><span class="s2">&quot;error&quot;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">message</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span> <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">message</span> <span class="k">instanceof</span> <span class="nb">Error</span> <span class="o">&amp;&amp;</span> <span class="nx">debug</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">message</span><span class="p">.</span><span class="nx">stack</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">inspect</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">message</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">noOp</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">;</span> <span class="p">}</span>
<span class="kd">var</span> <span class="nx">makeLogger</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">level</span><span class="p">,</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span> 
    <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">level</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;\n&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">Logger</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">logger</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span><span class="o">||</span><span class="p">{};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25">&#182;</a>
</div>
<p>Default options</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nx">options</span><span class="p">.</span><span class="nx">level</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">level</span> <span class="o">||</span> <span class="s2">&quot;info&quot;</span><span class="p">;</span>
  <span class="nx">options</span><span class="p">.</span><span class="nx">timestamp</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">timestamp</span> <span class="o">||</span> <span class="kc">true</span><span class="p">;</span>
  <span class="nx">options</span><span class="p">.</span><span class="nx">prefix</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">prefix</span> <span class="o">||</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
  <span class="nx">logger</span><span class="p">.</span><span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26">&#182;</a>
</div>
<p>Allows a prefix to be added to the message.</p>

<p>var logger = new Ax({ module: 'Haiku' })
   logger.warn('this is going to be awesome!');
   //=> Haiku: this is going to be awesome!</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">if</span> <span class="p">(</span><span class="nx">logger</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">module</span><span class="p">){</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">prefix</span> <span class="o">=</span> <span class="nx">logger</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">module</span><span class="p">;</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27">&#182;</a>
</div>
<p>Write to stderr or a file</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">if</span> <span class="p">(</span><span class="nx">logger</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">file</span><span class="p">){</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">stream</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">createWriteStream</span><span class="p">(</span><span class="nx">logger</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">file</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;flags&quot;</span><span class="o">:</span> <span class="s2">&quot;a&quot;</span><span class="p">});</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">title</span> <span class="o">===</span> <span class="s2">&quot;node&quot;</span><span class="p">)</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">stream</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">stderr</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">title</span> <span class="o">===</span> <span class="s2">&quot;browser&quot;</span><span class="p">)</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">stream</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28">&#182;</a>
</div>
<p>Work around weird console context issue: <a href='http://code.google.com/p/chromium/issues/detail?id=48662'>http://code.google.com/p/chromium/issues/detail?id=48662</a></p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">return</span> <span class="nx">console</span><span class="p">[</span><span class="nx">logger</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">level</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="nx">console</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="k">switch</span><span class="p">(</span><span class="nx">logger</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">level</span><span class="p">){</span>
    <span class="k">case</span> <span class="s1">&#39;debug&#39;</span><span class="o">:</span>
      <span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span> <span class="s1">&#39;info&#39;</span><span class="p">,</span> <span class="s1">&#39;warn&#39;</span><span class="p">].</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">level</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">logger</span><span class="p">[</span><span class="nx">level</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Logger</span><span class="p">.</span><span class="nx">writer</span><span class="p">(</span><span class="nx">level</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="k">case</span> <span class="s1">&#39;info&#39;</span><span class="o">:</span>
      <span class="p">[</span><span class="s1">&#39;info&#39;</span><span class="p">,</span> <span class="s1">&#39;warn&#39;</span><span class="p">].</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">level</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">logger</span><span class="p">[</span><span class="nx">level</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Logger</span><span class="p">.</span><span class="nx">writer</span><span class="p">(</span><span class="nx">level</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="k">case</span> <span class="s1">&#39;warn&#39;</span><span class="o">:</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">warn</span> <span class="o">=</span> <span class="nx">Logger</span><span class="p">.</span><span class="nx">writer</span><span class="p">(</span><span class="s1">&#39;warn&#39;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29">&#182;</a>
</div>
<p>Used to define logger methods</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">Logger</span><span class="p">.</span><span class="nx">writer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">level</span><span class="p">){</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">logger</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">title</span> <span class="o">===</span> <span class="s2">&quot;node&quot;</span><span class="p">)</span>
  <span class="nx">logger</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">logger</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">level</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;\n&#39;</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">title</span> <span class="o">===</span> <span class="s2">&quot;browser&quot;</span><span class="p">)</span>
  <span class="nx">logger</span><span class="p">.</span><span class="nx">stream</span><span class="p">(</span><span class="nx">logger</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">level</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;\n&#39;</span><span class="p">);</span>

  <span class="p">};</span>
<span class="p">}</span>


<span class="nx">Logger</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">info</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){},</span>
  <span class="nx">debug</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){},</span>
  <span class="nx">warn</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){},</span>
  <span class="nx">error</span><span class="o">:</span> <span class="nx">Logger</span><span class="p">.</span><span class="nx">writer</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">),</span>
  <span class="nx">format</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">level</span><span class="p">,</span> <span class="nx">message</span><span class="p">){</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">message</span><span class="p">)</span> <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">logger</span> <span class="o">=</span> <span class="k">this</span>
      <span class="p">,</span> <span class="nx">prefix</span> <span class="o">=</span> <span class="nx">logger</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">prefix</span>
      <span class="p">,</span> <span class="nx">timestamp</span> <span class="o">=</span> <span class="nx">logger</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">timestamp</span> <span class="o">?</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">())</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span>
    <span class="p">;</span>

    <span class="k">return</span> <span class="p">(</span><span class="nx">prefix</span> <span class="o">+</span> <span class="nx">timestamp</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="nx">message</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Logger</span><span class="p">;</span>

<span class="p">});</span>

<span class="nx">require</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s2">&quot;util&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span> <span class="nx">exports</span><span class="p">,</span> <span class="nx">__dirname</span><span class="p">,</span> <span class="nx">__filename</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30">&#182;</a>
</div>
<p>todo</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="p">});</span>

<span class="nx">require</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s2">&quot;fs&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span> <span class="nx">exports</span><span class="p">,</span> <span class="nx">__dirname</span><span class="p">,</span> <span class="nx">__filename</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31">&#182;</a>
</div>
<p>nothing to see here... no file methods for the browser</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="p">});</span>

<span class="nx">require</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s2">&quot;/node_modules/cookiejar/package.json&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span> <span class="nx">exports</span><span class="p">,</span> <span class="nx">__dirname</span><span class="p">,</span> <span class="nx">__filename</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;main&quot;</span><span class="o">:</span><span class="s2">&quot;cookiejar.js&quot;</span><span class="p">}</span>
<span class="p">});</span>

<span class="nx">require</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s2">&quot;/node_modules/cookiejar/cookiejar.js&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span> <span class="nx">exports</span><span class="p">,</span> <span class="nx">__dirname</span><span class="p">,</span> <span class="nx">__filename</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">exports</span><span class="p">.</span><span class="nx">CookieAccessInfo</span><span class="o">=</span><span class="nx">CookieAccessInfo</span><span class="o">=</span><span class="kd">function</span> <span class="nx">CookieAccessInfo</span><span class="p">(</span><span class="nx">domain</span><span class="p">,</span><span class="nx">path</span><span class="p">,</span><span class="nx">secure</span><span class="p">,</span><span class="nx">script</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="k">this</span> <span class="k">instanceof</span> <span class="nx">CookieAccessInfo</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">domain</span><span class="o">=</span><span class="nx">domain</span><span class="o">||</span><span class="kc">undefined</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="o">=</span><span class="nx">path</span><span class="o">||</span><span class="s2">&quot;/&quot;</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">secure</span><span class="o">=!!</span><span class="nx">secure</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">script</span><span class="o">=!!</span><span class="nx">script</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">CookieAccessInfo</span><span class="p">(</span><span class="nx">domain</span><span class="p">,</span><span class="nx">path</span><span class="p">,</span><span class="nx">secure</span><span class="p">,</span><span class="nx">script</span><span class="p">)</span>    
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">Cookie</span><span class="o">=</span><span class="nx">Cookie</span><span class="o">=</span><span class="kd">function</span> <span class="nx">Cookie</span><span class="p">(</span><span class="nx">cookiestr</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">cookiestr</span> <span class="k">instanceof</span> <span class="nx">Cookie</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">cookiestr</span><span class="p">;</span>
  <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="k">this</span> <span class="k">instanceof</span> <span class="nx">Cookie</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">expiration_date</span> <span class="o">=</span> <span class="kc">Infinity</span><span class="p">;</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="p">;</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">domain</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">secure</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">//how to define?</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">noscript</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">//httponly</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">cookiestr</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">cookiestr</span><span class="p">)</span>
          <span class="p">}</span>
          <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">Cookie</span><span class="p">(</span><span class="nx">cookiestr</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">Cookie</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">toString</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">str</span><span class="o">=</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="o">+</span><span class="s2">&quot;=&quot;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">value</span><span class="p">];</span>
  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">expiration_date</span> <span class="o">!==</span> <span class="kc">Infinity</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">str</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;expires=&quot;</span><span class="o">+</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">expiration_date</span><span class="p">)).</span><span class="nx">toGMTString</span><span class="p">());</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">domain</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">str</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;domain=&quot;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">domain</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">str</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;path=&quot;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">secure</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">str</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;secure&quot;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">noscript</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">str</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;httponly&quot;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">str</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;; &quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">Cookie</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toValueString</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">toValueString</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="o">+</span><span class="s2">&quot;=&quot;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">cookie_str_splitter</span><span class="o">=</span><span class="sr">/[:](?=\s*[a-zA-Z0-9_\-]+\s*[=])/g</span>
<span class="nx">Cookie</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">parse</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="k">this</span> <span class="k">instanceof</span> <span class="nx">Cookie</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">parts</span><span class="o">=</span><span class="nx">str</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
      <span class="p">,</span> <span class="nx">pair</span><span class="o">=</span><span class="nx">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">match</span><span class="p">(</span><span class="sr">/([^=]+)=((?:.|\n)*)/</span><span class="p">)</span>
      <span class="p">,</span> <span class="nx">key</span><span class="o">=</span><span class="nx">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
      <span class="p">,</span> <span class="nx">value</span><span class="o">=</span><span class="nx">pair</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">key</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
    
      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">parts</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">pair</span><span class="o">=</span><span class="nx">parts</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">match</span><span class="p">(</span><span class="sr">/([^=]+)(?:=((?:.|\n)*))?/</span><span class="p">)</span>
        <span class="p">,</span> <span class="nx">key</span><span class="o">=</span><span class="nx">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">trim</span><span class="p">().</span><span class="nx">toLowerCase</span><span class="p">()</span>
        <span class="p">,</span> <span class="nx">value</span><span class="o">=</span><span class="nx">pair</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
        <span class="k">switch</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">case</span> <span class="s2">&quot;httponly&quot;</span><span class="o">:</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">noscript</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
          <span class="k">case</span> <span class="s2">&quot;expires&quot;</span><span class="o">:</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">expiration_date</span> <span class="o">=</span> <span class="nx">value</span>
              <span class="o">?</span> <span class="nb">Number</span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span>
              <span class="o">:</span> <span class="kc">Infinity</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
          <span class="k">case</span> <span class="s2">&quot;path&quot;</span><span class="o">:</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="nx">value</span>
              <span class="o">?</span> <span class="nx">value</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span>
              <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
          <span class="k">case</span> <span class="s2">&quot;domain&quot;</span><span class="o">:</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">domain</span> <span class="o">=</span> <span class="nx">value</span>
              <span class="o">?</span> <span class="nx">value</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span>
              <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
          <span class="k">case</span> <span class="s2">&quot;secure&quot;</span><span class="o">:</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">secure</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="k">break</span>
        <span class="p">}</span>
      <span class="p">}</span>
    
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Cookie</span><span class="p">().</span><span class="nx">parse</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">Cookie</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">matches</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">matches</span><span class="p">(</span><span class="nx">access_info</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">noscript</span> <span class="o">&amp;&amp;</span> <span class="nx">access_info</span><span class="p">.</span><span class="nx">script</span>
  <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">secure</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">access_info</span><span class="p">.</span><span class="nx">secure</span>
  <span class="o">||</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">collidesWith</span><span class="p">(</span><span class="nx">access_info</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">false</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">Cookie</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">collidesWith</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">collidesWith</span><span class="p">(</span><span class="nx">access_info</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">path</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">access_info</span><span class="p">.</span><span class="nx">path</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">domain</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">access_info</span><span class="p">.</span><span class="nx">domain</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">false</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">path</span> <span class="o">&amp;&amp;</span> <span class="nx">access_info</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="p">)</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">domain</span><span class="o">===</span><span class="nx">access_info</span><span class="p">.</span><span class="nx">domain</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">domain</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">domain</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">===</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">wildcard</span><span class="o">=</span><span class="nx">access_info</span><span class="p">.</span><span class="nx">domain</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">domain</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">wildcard</span><span class="o">===-</span><span class="mi">1</span> <span class="o">||</span> <span class="nx">wildcard</span><span class="o">!==</span><span class="nx">access_info</span><span class="p">.</span><span class="nx">domain</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="k">this</span><span class="p">.</span><span class="nx">domain</span><span class="p">.</span><span class="nx">length</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">domain</span><span class="p">){</span>
    <span class="k">return</span> <span class="kc">false</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">CookieJar</span><span class="o">=</span><span class="nx">CookieJar</span><span class="o">=</span><span class="kd">function</span> <span class="nx">CookieJar</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="k">this</span> <span class="k">instanceof</span> <span class="nx">CookieJar</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">cookies</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1">//name: [Cookie]</span>
    
      <span class="k">this</span><span class="p">.</span><span class="nx">setCookie</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">setCookie</span><span class="p">(</span><span class="nx">cookie</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">cookie</span> <span class="o">=</span> <span class="nx">Cookie</span><span class="p">(</span><span class="nx">cookie</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32">&#182;</a>
</div>
<p>Delete the cookie if the set is past the current time</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="kd">var</span> <span class="nx">remove</span> <span class="o">=</span> <span class="nx">cookie</span><span class="p">.</span><span class="nx">expiration_date</span> <span class="o">&lt;=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">cookie</span><span class="p">.</span><span class="nx">name</span> <span class="k">in</span> <span class="nx">cookies</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">cookies_list</span> <span class="o">=</span> <span class="nx">cookies</span><span class="p">[</span><span class="nx">cookie</span><span class="p">.</span><span class="nx">name</span><span class="p">];</span>
          <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">cookies_list</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">collidable_cookie</span> <span class="o">=</span> <span class="nx">cookies_list</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">collidable_cookie</span><span class="p">.</span><span class="nx">collidesWith</span><span class="p">(</span><span class="nx">cookie</span><span class="p">))</span> <span class="p">{</span>
              <span class="k">if</span><span class="p">(</span><span class="nx">remove</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">cookies_list</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">cookies_list</span><span class="p">.</span><span class="nx">length</span><span class="o">===</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">delete</span> <span class="nx">cookies</span><span class="p">[</span><span class="nx">cookie</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
              <span class="p">}</span>
              <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">cookies_list</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">=</span><span class="nx">cookie</span><span class="p">;</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">remove</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="nx">cookies_list</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">cookie</span><span class="p">);</span>
          <span class="k">return</span> <span class="nx">cookie</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">remove</span><span class="p">){</span>
          <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">cookies</span><span class="p">[</span><span class="nx">cookie</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="nx">cookie</span><span class="p">];</span>
        <span class="p">}</span>
      <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33">&#182;</a>
</div>
<p>returns a cookie</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">this</span><span class="p">.</span><span class="nx">getCookie</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">getCookie</span><span class="p">(</span><span class="nx">cookie_name</span><span class="p">,</span><span class="nx">access_info</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">cookies_list</span> <span class="o">=</span> <span class="nx">cookies</span><span class="p">[</span><span class="nx">cookie_name</span><span class="p">];</span>
        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">cookies_list</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">cookie</span> <span class="o">=</span> <span class="nx">cookies_list</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">cookie</span><span class="p">.</span><span class="nx">expiration_date</span> <span class="o">&lt;=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">cookies_list</span><span class="p">.</span><span class="nx">length</span><span class="o">===</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">delete</span> <span class="nx">cookies</span><span class="p">[</span><span class="nx">cookie</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span>
            <span class="p">}</span>
            <span class="k">continue</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">cookie</span><span class="p">.</span><span class="nx">matches</span><span class="p">(</span><span class="nx">access_info</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">cookie</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34">&#182;</a>
</div>
<p>returns a list of cookies</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">this</span><span class="p">.</span><span class="nx">getCookies</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">getCookies</span><span class="p">(</span><span class="nx">access_info</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">matches</span><span class="o">=</span><span class="p">[];</span>
        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">cookie_name</span> <span class="k">in</span> <span class="nx">cookies</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">cookie</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">getCookie</span><span class="p">(</span><span class="nx">cookie_name</span><span class="p">,</span><span class="nx">access_info</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">cookie</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">matches</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">cookie</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">matches</span><span class="p">.</span><span class="nx">toString</span><span class="o">=</span><span class="kd">function</span> <span class="nx">toString</span><span class="p">(){</span><span class="k">return</span> <span class="nx">matches</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">);}</span>
            <span class="nx">matches</span><span class="p">.</span><span class="nx">toValueString</span><span class="o">=</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="k">return</span> <span class="nx">matches</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">c</span><span class="p">){</span><span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">toValueString</span><span class="p">();}).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">);}</span>
        <span class="k">return</span> <span class="nx">matches</span><span class="p">;</span>
      <span class="p">}</span>
    
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">CookieJar</span><span class="p">()</span>
<span class="p">}</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35">&#182;</a>
</div>
<p>returns list of cookies that were set correctly</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">CookieJar</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setCookies</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">setCookies</span><span class="p">(</span><span class="nx">cookies</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">cookies</span><span class="o">=</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">cookies</span><span class="p">)</span>
    <span class="o">?</span><span class="nx">cookies</span>
    <span class="o">:</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="nx">cookie_str_splitter</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">successful</span><span class="o">=</span><span class="p">[]</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">cookie</span> <span class="o">=</span> <span class="nx">Cookie</span><span class="p">(</span><span class="nx">cookies</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
    <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">setCookie</span><span class="p">(</span><span class="nx">cookie</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">successful</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">cookie</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">successful</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">});</span>

<span class="nx">require</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s2">&quot;/shred/request.js&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span> <span class="nx">exports</span><span class="p">,</span> <span class="nx">__dirname</span><span class="p">,</span> <span class="nx">__filename</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36">&#182;</a>
</div>
<p>The request object encapsulates a request, creating a Node.js HTTP request and
then handling the response.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="kd">var</span> <span class="nx">HTTP</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">HTTPS</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;https&quot;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">parseUri</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./parseUri&quot;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">Emitter</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;events&#39;</span><span class="p">).</span><span class="nx">EventEmitter</span>
  <span class="p">,</span> <span class="nx">sprintf</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;sprintf&quot;</span><span class="p">).</span><span class="nx">sprintf</span>
  <span class="p">,</span> <span class="nx">Response</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./response&quot;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">HeaderMixins</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./mixins/headers&quot;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">Content</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./content&quot;</span><span class="p">)</span>
<span class="p">;</span>

<span class="kd">var</span> <span class="nx">STATUS_CODES</span> <span class="o">=</span> <span class="nx">HTTP</span><span class="p">.</span><span class="nx">STATUS_CODES</span> <span class="o">||</span> <span class="p">{</span>
    <span class="mi">100</span> <span class="o">:</span> <span class="s1">&#39;Continue&#39;</span><span class="p">,</span>
    <span class="mi">101</span> <span class="o">:</span> <span class="s1">&#39;Switching Protocols&#39;</span><span class="p">,</span>
    <span class="mi">102</span> <span class="o">:</span> <span class="s1">&#39;Processing&#39;</span><span class="p">,</span> <span class="c1">// RFC 2518, obsoleted by RFC 4918</span>
    <span class="mi">200</span> <span class="o">:</span> <span class="s1">&#39;OK&#39;</span><span class="p">,</span>
    <span class="mi">201</span> <span class="o">:</span> <span class="s1">&#39;Created&#39;</span><span class="p">,</span>
    <span class="mi">202</span> <span class="o">:</span> <span class="s1">&#39;Accepted&#39;</span><span class="p">,</span>
    <span class="mi">203</span> <span class="o">:</span> <span class="s1">&#39;Non-Authoritative Information&#39;</span><span class="p">,</span>
    <span class="mi">204</span> <span class="o">:</span> <span class="s1">&#39;No Content&#39;</span><span class="p">,</span>
    <span class="mi">205</span> <span class="o">:</span> <span class="s1">&#39;Reset Content&#39;</span><span class="p">,</span>
    <span class="mi">206</span> <span class="o">:</span> <span class="s1">&#39;Partial Content&#39;</span><span class="p">,</span>
    <span class="mi">207</span> <span class="o">:</span> <span class="s1">&#39;Multi-Status&#39;</span><span class="p">,</span> <span class="c1">// RFC 4918</span>
    <span class="mi">300</span> <span class="o">:</span> <span class="s1">&#39;Multiple Choices&#39;</span><span class="p">,</span>
    <span class="mi">301</span> <span class="o">:</span> <span class="s1">&#39;Moved Permanently&#39;</span><span class="p">,</span>
    <span class="mi">302</span> <span class="o">:</span> <span class="s1">&#39;Moved Temporarily&#39;</span><span class="p">,</span>
    <span class="mi">303</span> <span class="o">:</span> <span class="s1">&#39;See Other&#39;</span><span class="p">,</span>
    <span class="mi">304</span> <span class="o">:</span> <span class="s1">&#39;Not Modified&#39;</span><span class="p">,</span>
    <span class="mi">305</span> <span class="o">:</span> <span class="s1">&#39;Use Proxy&#39;</span><span class="p">,</span>
    <span class="mi">307</span> <span class="o">:</span> <span class="s1">&#39;Temporary Redirect&#39;</span><span class="p">,</span>
    <span class="mi">400</span> <span class="o">:</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span>
    <span class="mi">401</span> <span class="o">:</span> <span class="s1">&#39;Unauthorized&#39;</span><span class="p">,</span>
    <span class="mi">402</span> <span class="o">:</span> <span class="s1">&#39;Payment Required&#39;</span><span class="p">,</span>
    <span class="mi">403</span> <span class="o">:</span> <span class="s1">&#39;Forbidden&#39;</span><span class="p">,</span>
    <span class="mi">404</span> <span class="o">:</span> <span class="s1">&#39;Not Found&#39;</span><span class="p">,</span>
    <span class="mi">405</span> <span class="o">:</span> <span class="s1">&#39;Method Not Allowed&#39;</span><span class="p">,</span>
    <span class="mi">406</span> <span class="o">:</span> <span class="s1">&#39;Not Acceptable&#39;</span><span class="p">,</span>
    <span class="mi">407</span> <span class="o">:</span> <span class="s1">&#39;Proxy Authentication Required&#39;</span><span class="p">,</span>
    <span class="mi">408</span> <span class="o">:</span> <span class="s1">&#39;Request Time-out&#39;</span><span class="p">,</span>
    <span class="mi">409</span> <span class="o">:</span> <span class="s1">&#39;Conflict&#39;</span><span class="p">,</span>
    <span class="mi">410</span> <span class="o">:</span> <span class="s1">&#39;Gone&#39;</span><span class="p">,</span>
    <span class="mi">411</span> <span class="o">:</span> <span class="s1">&#39;Length Required&#39;</span><span class="p">,</span>
    <span class="mi">412</span> <span class="o">:</span> <span class="s1">&#39;Precondition Failed&#39;</span><span class="p">,</span>
    <span class="mi">413</span> <span class="o">:</span> <span class="s1">&#39;Request Entity Too Large&#39;</span><span class="p">,</span>
    <span class="mi">414</span> <span class="o">:</span> <span class="s1">&#39;Request-URI Too Large&#39;</span><span class="p">,</span>
    <span class="mi">415</span> <span class="o">:</span> <span class="s1">&#39;Unsupported Media Type&#39;</span><span class="p">,</span>
    <span class="mi">416</span> <span class="o">:</span> <span class="s1">&#39;Requested Range Not Satisfiable&#39;</span><span class="p">,</span>
    <span class="mi">417</span> <span class="o">:</span> <span class="s1">&#39;Expectation Failed&#39;</span><span class="p">,</span>
    <span class="mi">418</span> <span class="o">:</span> <span class="s1">&#39;I\&#39;m a teapot&#39;</span><span class="p">,</span> <span class="c1">// RFC 2324</span>
    <span class="mi">422</span> <span class="o">:</span> <span class="s1">&#39;Unprocessable Entity&#39;</span><span class="p">,</span> <span class="c1">// RFC 4918</span>
    <span class="mi">423</span> <span class="o">:</span> <span class="s1">&#39;Locked&#39;</span><span class="p">,</span> <span class="c1">// RFC 4918</span>
    <span class="mi">424</span> <span class="o">:</span> <span class="s1">&#39;Failed Dependency&#39;</span><span class="p">,</span> <span class="c1">// RFC 4918</span>
    <span class="mi">425</span> <span class="o">:</span> <span class="s1">&#39;Unordered Collection&#39;</span><span class="p">,</span> <span class="c1">// RFC 4918</span>
    <span class="mi">426</span> <span class="o">:</span> <span class="s1">&#39;Upgrade Required&#39;</span><span class="p">,</span> <span class="c1">// RFC 2817</span>
    <span class="mi">500</span> <span class="o">:</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span>
    <span class="mi">501</span> <span class="o">:</span> <span class="s1">&#39;Not Implemented&#39;</span><span class="p">,</span>
    <span class="mi">502</span> <span class="o">:</span> <span class="s1">&#39;Bad Gateway&#39;</span><span class="p">,</span>
    <span class="mi">503</span> <span class="o">:</span> <span class="s1">&#39;Service Unavailable&#39;</span><span class="p">,</span>
    <span class="mi">504</span> <span class="o">:</span> <span class="s1">&#39;Gateway Time-out&#39;</span><span class="p">,</span>
    <span class="mi">505</span> <span class="o">:</span> <span class="s1">&#39;HTTP Version not supported&#39;</span><span class="p">,</span>
    <span class="mi">506</span> <span class="o">:</span> <span class="s1">&#39;Variant Also Negotiates&#39;</span><span class="p">,</span> <span class="c1">// RFC 2295</span>
    <span class="mi">507</span> <span class="o">:</span> <span class="s1">&#39;Insufficient Storage&#39;</span><span class="p">,</span> <span class="c1">// RFC 4918</span>
    <span class="mi">509</span> <span class="o">:</span> <span class="s1">&#39;Bandwidth Limit Exceeded&#39;</span><span class="p">,</span>
    <span class="mi">510</span> <span class="o">:</span> <span class="s1">&#39;Not Extended&#39;</span> <span class="c1">// RFC 2774</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37">&#182;</a>
</div>
<p>The Shred object itself constructs the <code>Request</code> object. You should rarely
need to do this directly.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="kd">var</span> <span class="nx">Request</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">log</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">logger</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">cookieJar</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">cookieJar</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">encoding</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">encoding</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">logCurl</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">logCurl</span><span class="p">;</span>
  <span class="nx">processOptions</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">options</span><span class="o">||</span><span class="p">{});</span>
  <span class="nx">createRequest</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-38" id="section-38">&#182;</a>
</div>
<p>A <code>Request</code> has a number of properties, many of which help with details like
URL parsing or defaulting the port for the request.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperties</span><span class="p">(</span><span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-39" id="section-39">&#182;</a>
</div>
<ul>
<li><strong>url</strong>. You can set the <code>url</code> property with a valid URL string and all the
URL-related properties (host, port, etc.) will be automatically set on the
request object.</li>
</ul>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="nx">url</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">scheme</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span> <span class="p">}</span>
      <span class="k">return</span> <span class="nx">sprintf</span><span class="p">(</span><span class="s2">&quot;%s://%s:%s%s&quot;</span><span class="p">,</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">scheme</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">host</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span>
          <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">proxy</span> <span class="o">?</span> <span class="s2">&quot;/&quot;</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="p">)</span> <span class="o">+</span>
          <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">query</span> <span class="o">?</span> <span class="p">(</span><span class="s2">&quot;?&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">)</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">));</span>
    <span class="p">},</span>
    <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">_url</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">_url</span> <span class="o">=</span> <span class="nx">parseUri</span><span class="p">(</span><span class="nx">_url</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">scheme</span> <span class="o">=</span> <span class="nx">_url</span><span class="p">.</span><span class="nx">protocol</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">host</span> <span class="o">=</span> <span class="nx">_url</span><span class="p">.</span><span class="nx">host</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">port</span> <span class="o">=</span> <span class="nx">_url</span><span class="p">.</span><span class="nx">port</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="nx">_url</span><span class="p">.</span><span class="nx">path</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">query</span> <span class="o">=</span> <span class="nx">_url</span><span class="p">.</span><span class="nx">query</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">},</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-40" id="section-40">&#182;</a>
</div>
<ul>
<li><strong>headers</strong>. Returns a hash representing the request headers. You can't set
this directly, only get it. You can add or modify headers by using the
<code>setHeader</code> or <code>setHeaders</code> method. This ensures that the headers are
normalized - that is, you don't accidentally send <code>Content-Type</code> and
<code>content-type</code> headers. Keep in mind that if you modify the returned hash,
it will <em>not</em> modify the request headers.</li>
</ul>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">getHeaders</span><span class="p">();</span>
    <span class="p">},</span>
    <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">},</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-41" id="section-41">&#182;</a>
</div>
<ul>
<li><strong>port</strong>. Unless you set the <code>port</code> explicitly or include it in the URL, it
will default based on the scheme.</li>
</ul>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="nx">port</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_port</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">switch</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">scheme</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">case</span> <span class="s2">&quot;https&quot;</span><span class="o">:</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_port</span> <span class="o">=</span> <span class="mi">443</span><span class="p">;</span>
          <span class="k">case</span> <span class="s2">&quot;http&quot;</span><span class="o">:</span>
          <span class="k">default</span><span class="o">:</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_port</span> <span class="o">=</span> <span class="mi">80</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_port</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">_port</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span> <span class="k">return</span> <span class="k">this</span><span class="p">;</span> <span class="p">},</span>
    <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">},</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-42" id="section-42">&#182;</a>
</div>
<ul>
<li><strong>method</strong>. The request method - <code>get</code>, <code>put</code>, <code>post</code>, etc. that will be
used to make the request. Defaults to <code>get</code>.</li>
</ul>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="nx">method</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_method</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_method</span><span class="o">||</span><span class="s2">&quot;GET&quot;</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_method</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span> <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">},</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-43" id="section-43">&#182;</a>
</div>
<ul>
<li><strong>query</strong>. Can be set either with a query string or a hash (object). Get
will always return a properly escaped query string or null if there is no
query component for the request.</li>
</ul>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="nx">query</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_query</span><span class="p">;},</span>
    <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">stringify</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">hash</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">hash</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">query</span> <span class="o">+=</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">hash</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;&amp;&#39;</span><span class="p">;</span>
        <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-44" id="section-44">&#182;</a>
</div>
<p>Remove the last '&amp;'</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">query</span> <span class="o">=</span> <span class="nx">query</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">query</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">value</span> <span class="o">=</span> <span class="nx">stringify</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_query</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">},</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-45" id="section-45">&#182;</a>
</div>
<ul>
<li><strong>parameters</strong>. This will return the query parameters in the form of a hash
(object).</li>
</ul>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="nx">parameters</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">QueryString</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_query</span><span class="o">||</span><span class="s2">&quot;&quot;</span><span class="p">);</span> <span class="p">},</span>
    <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">},</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-46" id="section-46">&#182;</a>
</div>
<ul>
<li><strong>content</strong>. (Aliased as <code>body</code>.) Set this to add a content entity to the
request. Attempts to use the <code>content-type</code> header to determine what to do
with the content value. Get this to get back a <a href="./content.html"><code>Content</code>
object</a>.</li>
</ul>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="nx">body</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_body</span><span class="p">;</span> <span class="p">},</span>
    <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_body</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Content</span><span class="p">({</span>
        <span class="nx">data</span><span class="o">:</span> <span class="nx">value</span><span class="p">,</span>
        <span class="nx">type</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">getHeader</span><span class="p">(</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">)</span>
      <span class="p">});</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s2">&quot;Content-Length&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">},</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-47" id="section-47">&#182;</a>
</div>
<ul>
<li><strong>timeout</strong>. Used to determine how long to wait for a response. Does not
distinguish between connect timeouts versus request timeouts. Set either in
milliseconds or with an object with temporal attributes (hours, minutes,
seconds) and convert it into milliseconds. Get will always return
milliseconds.</li>
</ul>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="nx">timeout</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_timeout</span><span class="p">;</span> <span class="p">},</span> <span class="c1">// in milliseconds</span>
    <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">timeout</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="k">this</span>
        <span class="p">,</span> <span class="nx">milliseconds</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">timeout</span><span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">timeout</span><span class="o">===</span><span class="s2">&quot;number&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="nx">milliseconds</span> <span class="o">=</span> <span class="nx">timeout</span><span class="p">;</span> <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">milliseconds</span> <span class="o">=</span> <span class="p">(</span><span class="nx">timeout</span><span class="p">.</span><span class="nx">milliseconds</span><span class="o">||</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
          <span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="p">((</span><span class="nx">timeout</span><span class="p">.</span><span class="nx">seconds</span><span class="o">||</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
              <span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="p">((</span><span class="nx">timeout</span><span class="p">.</span><span class="nx">minutes</span><span class="o">||</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
                <span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="p">(</span><span class="nx">timeout</span><span class="p">.</span><span class="nx">hours</span><span class="o">||</span><span class="mi">0</span><span class="p">))))));</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_timeout</span> <span class="o">=</span> <span class="nx">milliseconds</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">}</span>
<span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-48" id="section-48">&#182;</a>
</div>
<p>Alias <code>body</code> property to <code>content</code>. Since the <a href="./content.html">content object</a>
has a <code>body</code> attribute, it's preferable to use <code>content</code> since you can then
access the raw content data using <code>content.body</code>.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span><span class="s2">&quot;content&quot;</span><span class="p">,</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">getOwnPropertyDescriptor</span><span class="p">(</span><span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="s2">&quot;body&quot;</span><span class="p">));</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-49" id="section-49">&#182;</a>
</div>
<p>The <code>Request</code> object can be pretty overwhelming to view using the built-in
Node.js inspect method. We want to make it a bit more manageable. This
probably goes <a href="https://github.com/spire-io/shred/issues/2">too far in the other
direction</a>.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">inspect</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">headers</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">format_headers</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">summary</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&lt;Shred Request&gt; &quot;</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">method</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">(),</span>
      <span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
  <span class="k">return</span> <span class="p">[</span> <span class="nx">summary</span><span class="p">,</span> <span class="s2">&quot;- Headers:&quot;</span><span class="p">,</span> <span class="nx">headers</span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">format_headers</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">array</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="kd">var</span> <span class="nx">headers</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_headers</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">headers</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">headers</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">headers</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
      <span class="nx">array</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;\t&quot;</span> <span class="o">+</span> <span class="nx">key</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="nx">value</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">array</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">);</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-50" id="section-50">&#182;</a>
</div>
<p>Allow chainable 'on's:  shred.get({ ... }).on( ... ).  You can pass in a
single function, a pair (event, function), or a hash:
{ event: function, event: function }</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">on</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">eventOrHash</span><span class="p">,</span> <span class="nx">listener</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">emitter</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">emitter</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-51" id="section-51">&#182;</a>
</div>
<p>Pass in a single argument as a function then make it the default response handler</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">eventOrHash</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">emitter</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;response&#39;</span><span class="p">,</span> <span class="nx">eventOrHash</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">eventOrHash</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">eventOrHash</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">eventOrHash</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">emitter</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">eventOrHash</span><span class="p">[</span><span class="nx">key</span><span class="p">]);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">emitter</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">eventOrHash</span><span class="p">,</span> <span class="nx">listener</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-52" id="section-52">&#182;</a>
</div>
<p>Add in the header methods. Again, these ensure we don't get the same header
multiple times with different case conventions.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">HeaderMixins</span><span class="p">.</span><span class="nx">gettersAndSetters</span><span class="p">(</span><span class="nx">Request</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-53" id="section-53">&#182;</a>
</div>
<p><code>processOptions</code> is called from the constructor to handle all the work
associated with making sure we do our best to ensure we have a valid request.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="kd">var</span> <span class="nx">processOptions</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>

  <span class="nx">request</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;Processing request options ..&quot;</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-54" id="section-54">&#182;</a>
</div>
<p>We'll use <code>request.emitter</code> to manage the <code>on</code> event handlers.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nx">request</span><span class="p">.</span><span class="nx">emitter</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="nx">Emitter</span><span class="p">);</span>

  <span class="nx">request</span><span class="p">.</span><span class="nx">agent</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">agent</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-55" id="section-55">&#182;</a>
</div>
<p>Set up the handlers ...</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">on</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">options</span><span class="p">.</span><span class="nx">on</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">on</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">request</span><span class="p">.</span><span class="nx">emitter</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">on</span><span class="p">[</span><span class="nx">key</span><span class="p">]);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-56" id="section-56">&#182;</a>
</div>
<p>Make sure we were give a URL or a host</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">url</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">host</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">emitter</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;request_error&quot;</span><span class="p">,</span>
        <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;No url or url options (host, port, etc.)&quot;</span><span class="p">));</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-57" id="section-57">&#182;</a>
</div>
<p>Allow for the <a href="http://www.jmarshall.com/easy/http/#proxies">use of a proxy</a>.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">proxy</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">request</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">proxy</span><span class="p">;</span>
      <span class="nx">request</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">request</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-58" id="section-58">&#182;</a>
</div>
<p>Set the remaining options.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nx">request</span><span class="p">.</span><span class="nx">query</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">query</span><span class="o">||</span><span class="nx">options</span><span class="p">.</span><span class="nx">parameters</span><span class="o">||</span><span class="nx">request</span><span class="p">.</span><span class="nx">query</span> <span class="p">;</span>
  <span class="nx">request</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">method</span><span class="p">;</span>
  <span class="nx">request</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s2">&quot;user-agent&quot;</span><span class="p">,</span><span class="nx">options</span><span class="p">.</span><span class="nx">agent</span><span class="o">||</span><span class="s2">&quot;Shred&quot;</span><span class="p">);</span>
  <span class="nx">request</span><span class="p">.</span><span class="nx">setHeaders</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">headers</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">cookieJar</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">cookies</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">cookieJar</span><span class="p">.</span><span class="nx">getCookies</span><span class="p">(</span> <span class="nx">CookieAccessInfo</span><span class="p">(</span> <span class="nx">request</span><span class="p">.</span><span class="nx">host</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">path</span> <span class="p">)</span> <span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">cookieString</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">getHeader</span><span class="p">(</span><span class="s1">&#39;cookie&#39;</span><span class="p">)</span><span class="o">||</span><span class="s1">&#39;&#39;</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">cookieIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">cookieIndex</span> <span class="o">&lt;</span> <span class="nx">cookies</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">cookieIndex</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span> <span class="nx">cookieString</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="nx">cookieString</span><span class="p">[</span> <span class="nx">cookieString</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;;&#39;</span> <span class="p">)</span>
          <span class="p">{</span>
              <span class="nx">cookieString</span> <span class="o">+=</span> <span class="s1">&#39;;&#39;</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="nx">cookieString</span> <span class="o">+=</span> <span class="nx">cookies</span><span class="p">[</span> <span class="nx">cookieIndex</span> <span class="p">].</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span> <span class="o">+</span> <span class="nx">cookies</span><span class="p">[</span> <span class="nx">cookieIndex</span> <span class="p">].</span><span class="nx">value</span> <span class="o">+</span> <span class="s1">&#39;;&#39;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">request</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s2">&quot;cookie&quot;</span><span class="p">,</span> <span class="nx">cookieString</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-59" id="section-59">&#182;</a>
</div>
<p>The content entity can be set either using the <code>body</code> or <code>content</code> attributes.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">body</span><span class="o">||</span><span class="nx">options</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">content</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">body</span><span class="o">||</span><span class="nx">options</span><span class="p">.</span><span class="nx">content</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">request</span><span class="p">.</span><span class="nx">timeout</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">timeout</span><span class="p">;</span>

<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-60" id="section-60">&#182;</a>
</div>
<p><code>createRequest</code> is also called by the constructor, after <code>processOptions</code>.
This actually makes the request and processes the response, so <code>createRequest</code>
is a bit of a misnomer.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="kd">var</span> <span class="nx">createRequest</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">timeout</span> <span class="p">;</span>

  <span class="nx">request</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;Creating request ..&quot;</span><span class="p">);</span>
  <span class="nx">request</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>

  <span class="kd">var</span> <span class="nx">reqParams</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">host</span><span class="o">:</span> <span class="nx">request</span><span class="p">.</span><span class="nx">host</span><span class="p">,</span>
    <span class="nx">port</span><span class="o">:</span> <span class="nx">request</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span>
    <span class="nx">method</span><span class="o">:</span> <span class="nx">request</span><span class="p">.</span><span class="nx">method</span><span class="p">,</span>
    <span class="nx">path</span><span class="o">:</span> <span class="nx">request</span><span class="p">.</span><span class="nx">path</span> <span class="o">+</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">query</span> <span class="o">?</span> <span class="s1">&#39;?&#39;</span><span class="o">+</span><span class="nx">request</span><span class="p">.</span><span class="nx">query</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
    <span class="nx">headers</span><span class="o">:</span> <span class="nx">request</span><span class="p">.</span><span class="nx">getHeaders</span><span class="p">(),</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-61" id="section-61">&#182;</a>
</div>
<p>Node's HTTP/S modules will ignore this, but we are using the
browserify-http module in the browser for both HTTP and HTTPS, and this
is how you differentiate the two.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">scheme</span><span class="o">:</span> <span class="nx">request</span><span class="p">.</span><span class="nx">scheme</span><span class="p">,</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-62" id="section-62">&#182;</a>
</div>
<p>Use a provided agent.  'Undefined' is the default, which uses a global
agent.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">agent</span><span class="o">:</span> <span class="nx">request</span><span class="p">.</span><span class="nx">agent</span>
  <span class="p">};</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">logCurl</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">logCurl</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">scheme</span> <span class="o">==</span> <span class="s2">&quot;http&quot;</span> <span class="o">?</span> <span class="nx">HTTP</span> <span class="o">:</span> <span class="nx">HTTPS</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-63" id="section-63">&#182;</a>
</div>
<p>Set up the real request using the selected library. The request won't be
sent until we call <code>.end()</code>.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nx">request</span><span class="p">.</span><span class="nx">_raw</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">reqParams</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;Received response ..&quot;</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-64" id="section-64">&#182;</a>
</div>
<p>We haven't timed out and we have a response, so make sure we clear the
timeout so it doesn't fire while we're processing the response.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">timeout</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-65" id="section-65">&#182;</a>
</div>
<p>Construct a Shred <code>Response</code> object from the response. This will stream
the response, thus the need for the callback. We can access the response
entity safely once we're in the callback.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">response</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Response</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span> <span class="nx">request</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-66" id="section-66">&#182;</a>
</div>
<p>Set up some event magic. The precedence is given first to
status-specific handlers, then to responses for a given event, and then
finally to the more general <code>response</code> handler. In the last case, we
need to first make sure we're not dealing with a a redirect.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="kd">var</span> <span class="nx">emit</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">emitter</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">emitter</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">textStatus</span> <span class="o">=</span> <span class="nx">STATUS_CODES</span><span class="p">[</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">]</span> <span class="o">?</span> <span class="nx">STATUS_CODES</span><span class="p">[</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">].</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">emitter</span><span class="p">.</span><span class="nx">listeners</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">emitter</span><span class="p">.</span><span class="nx">listeners</span><span class="p">(</span><span class="nx">textStatus</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">emitter</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span>
          <span class="nx">emitter</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="nx">textStatus</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">emitter</span><span class="p">.</span><span class="nx">listeners</span><span class="p">(</span><span class="nx">event</span><span class="p">).</span><span class="nx">length</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">emitter</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">isRedirect</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">emitter</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;response&quot;</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-67" id="section-67">&#182;</a>
</div>
<p>console.warn("Request has no event listener for status code " + response.status);</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-68" id="section-68">&#182;</a>
</div>
<p>Next, check for a redirect. We simply repeat the request with the URL
given in the <code>Location</code> header. We fire a <code>redirect</code> event.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">isRedirect</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">request</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;Redirecting to &quot;</span>
            <span class="o">+</span> <span class="nx">response</span><span class="p">.</span><span class="nx">getHeader</span><span class="p">(</span><span class="s2">&quot;Location&quot;</span><span class="p">));</span>
        <span class="nx">request</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">getHeader</span><span class="p">(</span><span class="s2">&quot;Location&quot;</span><span class="p">);</span>
        <span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;redirect&quot;</span><span class="p">);</span>
        <span class="nx">createRequest</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-69" id="section-69">&#182;</a>
</div>
<p>Okay, it's not a redirect. Is it an error of some kind?</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">isError</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-70" id="section-70">&#182;</a>
</div>
<p>It looks like we're good shape. Trigger the <code>success</code> event.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-71" id="section-71">&#182;</a>
</div>
<p>We're still setting up the request. Next, we're going to handle error cases
where we have no response. We don't emit an error event because that event
takes a response. We don't response handlers to have to check for a null
value. However, we <a href="https://github.com/spire-io/shred/issues/3">should introduce a different event
type</a> for this type of error.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nx">request</span><span class="p">.</span><span class="nx">_raw</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">emitter</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;request_error&quot;</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="nx">request</span><span class="p">.</span><span class="nx">_raw</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;socket&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">emitter</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;socket&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
  <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-72" id="section-72">&#182;</a>
</div>
<p>TCP timeouts should also trigger the "response_error" event.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nx">request</span><span class="p">.</span><span class="nx">_raw</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;socket&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">_raw</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;timeout&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-73" id="section-73">&#182;</a>
</div>
<p>This should trigger the "error" event on the raw request, which will
trigger the "response_error" on the shred request.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">request</span><span class="p">.</span><span class="nx">_raw</span><span class="p">.</span><span class="nx">abort</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">});</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-74" id="section-74">&#182;</a>
</div>
<p>We're almost there. Next, we need to write the request entity to the
underlying request object.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;Streaming body: &#39;&quot;</span> <span class="o">+</span>
        <span class="nx">request</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">59</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39; ... &quot;</span><span class="p">);</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">_raw</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-75" id="section-75">&#182;</a>
</div>
<p>Finally, we need to set up the timeout. We do this last so that we don't
start the clock ticking until the last possible moment.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">timeout</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">timeout</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">request</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;Timeout fired, aborting request ...&quot;</span><span class="p">);</span>
      <span class="nx">request</span><span class="p">.</span><span class="nx">_raw</span><span class="p">.</span><span class="nx">abort</span><span class="p">();</span>
      <span class="nx">request</span><span class="p">.</span><span class="nx">emitter</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;timeout&quot;</span><span class="p">,</span> <span class="nx">request</span><span class="p">);</span>
    <span class="p">},</span><span class="nx">request</span><span class="p">.</span><span class="nx">timeout</span><span class="p">);</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-76" id="section-76">&#182;</a>
</div>
<p>The <code>.end()</code> method will cause the request to fire. Technically, it might
have already sent the headers and body.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nx">request</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;Sending request ...&quot;</span><span class="p">);</span>
  <span class="nx">request</span><span class="p">.</span><span class="nx">_raw</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-77" id="section-77">&#182;</a>
</div>
<p>Logs the curl command for the request.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">var</span> <span class="nx">logCurl</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">headers</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">getHeaders</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">headerString</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">headers</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">headerString</span> <span class="o">+=</span> <span class="s1">&#39;-H &quot;&#39;</span> <span class="o">+</span> <span class="nx">key</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="nx">headers</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&quot; &#39;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">bodyString</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">bodyString</span> <span class="o">+=</span> <span class="s2">&quot;-d &#39;&quot;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">body</span> <span class="o">+</span> <span class="s2">&quot;&#39; &quot;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">query</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span> <span class="o">?</span> <span class="s1">&#39;?&#39;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>

  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;curl &quot;</span> <span class="o">+</span>
    <span class="s2">&quot;-X &quot;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">method</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">scheme</span> <span class="o">+</span> <span class="s2">&quot;://&quot;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">host</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">port</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">path</span> <span class="o">+</span> <span class="nx">query</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span>
    <span class="nx">headerString</span> <span class="o">+</span>
    <span class="nx">bodyString</span>
  <span class="p">);</span>
<span class="p">};</span>


<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Request</span><span class="p">;</span>

<span class="p">});</span>

<span class="nx">require</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span> <span class="nx">exports</span><span class="p">,</span> <span class="nx">__dirname</span><span class="p">,</span> <span class="nx">__filename</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-78" id="section-78">&#182;</a>
</div>
<p>todo</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="p">});</span>

<span class="nx">require</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s2">&quot;https&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span> <span class="nx">exports</span><span class="p">,</span> <span class="nx">__dirname</span><span class="p">,</span> <span class="nx">__filename</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-79" id="section-79">&#182;</a>
</div>
<p>todo</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="p">});</span>

<span class="nx">require</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s2">&quot;/shred/parseUri.js&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span> <span class="nx">exports</span><span class="p">,</span> <span class="nx">__dirname</span><span class="p">,</span> <span class="nx">__filename</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-80" id="section-80">&#182;</a>
</div>
<p>parseUri 1.2.2
(c) Steven Levithan <stevenlevithan.com>
MIT License</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="kd">function</span> <span class="nx">parseUri</span> <span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">o</span>   <span class="o">=</span> <span class="nx">parseUri</span><span class="p">.</span><span class="nx">options</span><span class="p">,</span>
    <span class="nx">m</span>   <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">parser</span><span class="p">[</span><span class="nx">o</span><span class="p">.</span><span class="nx">strictMode</span> <span class="o">?</span> <span class="s2">&quot;strict&quot;</span> <span class="o">:</span> <span class="s2">&quot;loose&quot;</span><span class="p">].</span><span class="nx">exec</span><span class="p">(</span><span class="nx">str</span><span class="p">),</span>
    <span class="nx">uri</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="nx">i</span>   <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>

  <span class="k">while</span> <span class="p">(</span><span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="nx">uri</span><span class="p">[</span><span class="nx">o</span><span class="p">.</span><span class="nx">key</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">m</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">||</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>

  <span class="nx">uri</span><span class="p">[</span><span class="nx">o</span><span class="p">.</span><span class="nx">q</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="nx">uri</span><span class="p">[</span><span class="nx">o</span><span class="p">.</span><span class="nx">key</span><span class="p">[</span><span class="mi">12</span><span class="p">]].</span><span class="nx">replace</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">q</span><span class="p">.</span><span class="nx">parser</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">$0</span><span class="p">,</span> <span class="nx">$1</span><span class="p">,</span> <span class="nx">$2</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">$1</span><span class="p">)</span> <span class="nx">uri</span><span class="p">[</span><span class="nx">o</span><span class="p">.</span><span class="nx">q</span><span class="p">.</span><span class="nx">name</span><span class="p">][</span><span class="nx">$1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">$2</span><span class="p">;</span>
  <span class="p">});</span>

  <span class="k">return</span> <span class="nx">uri</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">parseUri</span><span class="p">.</span><span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">strictMode</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="nx">key</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">,</span><span class="s2">&quot;protocol&quot;</span><span class="p">,</span><span class="s2">&quot;authority&quot;</span><span class="p">,</span><span class="s2">&quot;userInfo&quot;</span><span class="p">,</span><span class="s2">&quot;user&quot;</span><span class="p">,</span><span class="s2">&quot;password&quot;</span><span class="p">,</span><span class="s2">&quot;host&quot;</span><span class="p">,</span><span class="s2">&quot;port&quot;</span><span class="p">,</span><span class="s2">&quot;relative&quot;</span><span class="p">,</span><span class="s2">&quot;path&quot;</span><span class="p">,</span><span class="s2">&quot;directory&quot;</span><span class="p">,</span><span class="s2">&quot;file&quot;</span><span class="p">,</span><span class="s2">&quot;query&quot;</span><span class="p">,</span><span class="s2">&quot;anchor&quot;</span><span class="p">],</span>
  <span class="nx">q</span><span class="o">:</span>   <span class="p">{</span>
    <span class="nx">name</span><span class="o">:</span>   <span class="s2">&quot;queryKey&quot;</span><span class="p">,</span>
    <span class="nx">parser</span><span class="o">:</span> <span class="sr">/(?:^|&amp;)([^&amp;=]*)=?([^&amp;]*)/g</span>
  <span class="p">},</span>
  <span class="nx">parser</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">strict</span><span class="o">:</span> <span class="sr">/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/</span><span class="p">,</span>
    <span class="nx">loose</span><span class="o">:</span>  <span class="sr">/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">parseUri</span><span class="p">;</span>

<span class="p">});</span>

<span class="nx">require</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s2">&quot;events&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span> <span class="nx">exports</span><span class="p">,</span> <span class="nx">__dirname</span><span class="p">,</span> <span class="nx">__filename</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">process</span><span class="p">.</span><span class="nx">EventEmitter</span><span class="p">)</span> <span class="nx">process</span><span class="p">.</span><span class="nx">EventEmitter</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{};</span>

<span class="kd">var</span> <span class="nx">EventEmitter</span> <span class="o">=</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">EventEmitter</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">EventEmitter</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">isArray</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span>
    <span class="o">?</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span>
    <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">xs</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">xs</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;[object Array]&#39;</span>
    <span class="p">}</span>
<span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-81" id="section-81">&#182;</a>
</div>
<p>By default EventEmitters will print a warning if more than
10 listeners are added to it. This is a useful default which
helps finding memory leaks.</p>

<p>Obviously not all Emitters should be limited to 10. This function allows
that to be increased. Set to zero for unlimited.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">var</span> <span class="nx">defaultMaxListeners</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="nx">EventEmitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setMaxListeners</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_events</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">_events</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_events</span><span class="p">.</span><span class="nx">maxListeners</span> <span class="o">=</span> <span class="nx">n</span><span class="p">;</span>
<span class="p">};</span>


<span class="nx">EventEmitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">emit</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-82" id="section-82">&#182;</a>
</div>
<p>If there is no 'error' event listener then throw.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_events</span> <span class="o">||</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_events</span><span class="p">.</span><span class="nx">error</span> <span class="o">||</span>
        <span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_events</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_events</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">length</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">instanceof</span> <span class="nb">Error</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="c1">// Unhandled &#39;error&#39; event</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Uncaught, unspecified &#39;error&#39; event.&quot;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_events</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">handler</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_events</span><span class="p">[</span><span class="nx">type</span><span class="p">];</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">handler</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">handler</span> <span class="o">==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-83" id="section-83">&#182;</a>
</div>
<p>fast cases</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
        <span class="nx">handler</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
        <span class="nx">handler</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
        <span class="nx">handler</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
        <span class="k">break</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-84" id="section-84">&#182;</a>
</div>
<p>slower</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">default</span><span class="o">:</span>
        <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="nx">handler</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>

  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">handler</span><span class="p">))</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">listeners</span> <span class="o">=</span> <span class="nx">handler</span><span class="p">.</span><span class="nx">slice</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">listeners</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">listeners</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>

  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-85" id="section-85">&#182;</a>
</div>
<p>EventEmitter is defined in src/node_events.cc
EventEmitter.prototype.emit() is also defined there.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">EventEmitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addListener</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">listener</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;function&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">listener</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;addListener only takes instances of Function&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_events</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">_events</span> <span class="o">=</span> <span class="p">{};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-86" id="section-86">&#182;</a>
</div>
<p>To avoid recursion in the case that type == "newListeners"! Before
adding it to the listeners, first emit "newListeners".</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;newListener&#39;</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">listener</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_events</span><span class="p">[</span><span class="nx">type</span><span class="p">])</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-87" id="section-87">&#182;</a>
</div>
<p>Optimize the case of one listener. Don't need the extra array object.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">_events</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span> <span class="o">=</span> <span class="nx">listener</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_events</span><span class="p">[</span><span class="nx">type</span><span class="p">]))</span> <span class="p">{</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-88" id="section-88">&#182;</a>
</div>
<p>Check for listener leak</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_events</span><span class="p">[</span><span class="nx">type</span><span class="p">].</span><span class="nx">warned</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">m</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_events</span><span class="p">.</span><span class="nx">maxListeners</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">m</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_events</span><span class="p">.</span><span class="nx">maxListeners</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">m</span> <span class="o">=</span> <span class="nx">defaultMaxListeners</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">m</span> <span class="o">&amp;&amp;</span> <span class="nx">m</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">_events</span><span class="p">[</span><span class="nx">type</span><span class="p">].</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_events</span><span class="p">[</span><span class="nx">type</span><span class="p">].</span><span class="nx">warned</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;(node) warning: possible EventEmitter memory &#39;</span> <span class="o">+</span>
                      <span class="s1">&#39;leak detected. %d listeners added. &#39;</span> <span class="o">+</span>
                      <span class="s1">&#39;Use emitter.setMaxListeners() to increase limit.&#39;</span><span class="p">,</span>
                      <span class="k">this</span><span class="p">.</span><span class="nx">_events</span><span class="p">[</span><span class="nx">type</span><span class="p">].</span><span class="nx">length</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">trace</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-89" id="section-89">&#182;</a>
</div>
<p>If we've already got an array, just append.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">_events</span><span class="p">[</span><span class="nx">type</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">listener</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-90" id="section-90">&#182;</a>
</div>
<p>Adding the second element, need to change to array.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">_events</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">_events</span><span class="p">[</span><span class="nx">type</span><span class="p">],</span> <span class="nx">listener</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">EventEmitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">on</span> <span class="o">=</span> <span class="nx">EventEmitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addListener</span><span class="p">;</span>

<span class="nx">EventEmitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">once</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">listener</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">g</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">removeListener</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">g</span><span class="p">);</span>
    <span class="nx">listener</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">EventEmitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">removeListener</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">listener</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;function&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">listener</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;removeListener only takes instances of Function&#39;</span><span class="p">);</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-91" id="section-91">&#182;</a>
</div>
<p>does not use listeners(), so no side effect of creating _events[type]</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_events</span> <span class="o">||</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_events</span><span class="p">[</span><span class="nx">type</span><span class="p">])</span> <span class="k">return</span> <span class="k">this</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">list</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_events</span><span class="p">[</span><span class="nx">type</span><span class="p">];</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">list</span><span class="p">))</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">list</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">listener</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">list</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">list</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
      <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">_events</span><span class="p">[</span><span class="nx">type</span><span class="p">];</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_events</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span> <span class="o">===</span> <span class="nx">listener</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">_events</span><span class="p">[</span><span class="nx">type</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">EventEmitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">removeAllListeners</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-92" id="section-92">&#182;</a>
</div>
<p>does not use listeners(), so no side effect of creating _events[type]</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">_events</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">_events</span><span class="p">[</span><span class="nx">type</span><span class="p">])</span> <span class="k">this</span><span class="p">.</span><span class="nx">_events</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">EventEmitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">listeners</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_events</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">_events</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_events</span><span class="p">[</span><span class="nx">type</span><span class="p">])</span> <span class="k">this</span><span class="p">.</span><span class="nx">_events</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isArray</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_events</span><span class="p">[</span><span class="nx">type</span><span class="p">]))</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_events</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">_events</span><span class="p">[</span><span class="nx">type</span><span class="p">]];</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_events</span><span class="p">[</span><span class="nx">type</span><span class="p">];</span>
<span class="p">};</span>

<span class="p">});</span>

<span class="nx">require</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s2">&quot;/node_modules/sprintf/package.json&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span> <span class="nx">exports</span><span class="p">,</span> <span class="nx">__dirname</span><span class="p">,</span> <span class="nx">__filename</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;main&quot;</span><span class="o">:</span><span class="s2">&quot;./lib/sprintf&quot;</span><span class="p">}</span>
<span class="p">});</span>

<span class="nx">require</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s2">&quot;/node_modules/sprintf/lib/sprintf.js&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span> <span class="nx">exports</span><span class="p">,</span> <span class="nx">__dirname</span><span class="p">,</span> <span class="nx">__filename</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-93" id="section-93">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>sprintf() for JavaScript 0.7-beta1
<a href='http://www.diveintojavascript.com/projects/javascript-sprintf'>http://www.diveintojavascript.com/projects/javascript-sprintf</a></p>
  </div>
  <div class="body"><p>Copyright (c) Alexandru Marasteanu <alexaholic [at) gmail (dot] com>
All rights reserved.</p>

<p>Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are met:
Redistributions of source code must retain the above copyright
notice, this list of conditions and the following disclaimer.
Redistributions in binary form must reproduce the above copyright
notice, this list of conditions and the following disclaimer in the
documentation and/or other materials provided with the distribution.
Neither the name of sprintf() for JavaScript nor the
names of its contributors may be used to endorse or promote products
derived from this software without specific prior written permission.</p>

<p>THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL Alexandru Marasteanu BE LIABLE FOR ANY
DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</p>

<p>Changelog:
2010.11.07 - 0.7-beta1-node
- converted it to a node.js compatible module</p>

<p>2010.09.06 - 0.7-beta1
- features: vsprintf, support for named placeholders
- enhancements: format cache, reduced global namespace pollution</p>

<p>2010.05.22 - 0.6:
- reverted to 0.4 and fixed the bug regarding the sign of the number 0
Note:
Thanks to Raphael Pigulla <raph (at] n3rd [dot) org> (<a href='http://www.n3rd.org/'>http://www.n3rd.org/</a>)
who warned me about a bug in 0.5, I discovered that the last update was
a regress. I appologize for that.</p>

<p>2010.05.09 - 0.5:
- bug fix: 0 is now preceeded with a + sign
- bug fix: the sign was not at the right position on padded results (Kamal Abdali)
- switched from GPL to BSD license</p>

<p>2007.10.21 - 0.4:
- unit test and patch (David Baird)</p>

<p>2007.09.17 - 0.3:
- bug fix: no longer throws exception on empty paramenters (Hans Pufal)</p>

<p>2007.09.11 - 0.2:
- feature: added argument swapping</p>

<p>2007.04.03 - 0.1:
- initial release</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="kd">var</span> <span class="nx">sprintf</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">function</span> <span class="nx">get_type</span><span class="p">(</span><span class="nx">variable</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">variable</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">str_repeat</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">multiplier</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">output</span> <span class="o">=</span> <span class="p">[];</span> <span class="nx">multiplier</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">output</span><span class="p">[</span><span class="o">--</span><span class="nx">multiplier</span><span class="p">]</span> <span class="o">=</span> <span class="nx">input</span><span class="p">)</span> <span class="p">{</span><span class="cm">/* do nothing */</span><span class="p">}</span>
    <span class="k">return</span> <span class="nx">output</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">str_format</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">str_format</span><span class="p">.</span><span class="nx">cache</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
      <span class="nx">str_format</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">str_format</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">str_format</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">str_format</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="nx">arguments</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">str_format</span><span class="p">.</span><span class="nx">format</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">parse_tree</span><span class="p">,</span> <span class="nx">argv</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">cursor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">tree_length</span> <span class="o">=</span> <span class="nx">parse_tree</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">node_type</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nx">arg</span><span class="p">,</span> <span class="nx">output</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">match</span><span class="p">,</span> <span class="nx">pad</span><span class="p">,</span> <span class="nx">pad_character</span><span class="p">,</span> <span class="nx">pad_length</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">tree_length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">node_type</span> <span class="o">=</span> <span class="nx">get_type</span><span class="p">(</span><span class="nx">parse_tree</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">node_type</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">parse_tree</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">node_type</span> <span class="o">===</span> <span class="s1">&#39;array&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">match</span> <span class="o">=</span> <span class="nx">parse_tree</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span> <span class="c1">// convenience purposes only</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span> <span class="c1">// keyword argument</span>
          <span class="nx">arg</span> <span class="o">=</span> <span class="nx">argv</span><span class="p">[</span><span class="nx">cursor</span><span class="p">];</span>
          <span class="k">for</span> <span class="p">(</span><span class="nx">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">k</span> <span class="o">&lt;</span> <span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span> <span class="nx">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arg</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="nx">k</span><span class="p">]))</span> <span class="p">{</span>
              <span class="k">throw</span><span class="p">(</span><span class="nx">sprintf</span><span class="p">(</span><span class="s1">&#39;[sprintf] property &quot;%s&quot; does not exist&#39;</span><span class="p">,</span> <span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="nx">k</span><span class="p">]));</span>
            <span class="p">}</span>
            <span class="nx">arg</span> <span class="o">=</span> <span class="nx">arg</span><span class="p">[</span><span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="nx">k</span><span class="p">]];</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span> <span class="c1">// positional argument (explicit)</span>
          <span class="nx">arg</span> <span class="o">=</span> <span class="nx">argv</span><span class="p">[</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span> <span class="c1">// positional argument (implicit)</span>
          <span class="nx">arg</span> <span class="o">=</span> <span class="nx">argv</span><span class="p">[</span><span class="nx">cursor</span><span class="o">++</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="sr">/[^s]/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">get_type</span><span class="p">(</span><span class="nx">arg</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;number&#39;</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">throw</span><span class="p">(</span><span class="nx">sprintf</span><span class="p">(</span><span class="s1">&#39;[sprintf] expecting number but found %s&#39;</span><span class="p">,</span> <span class="nx">get_type</span><span class="p">(</span><span class="nx">arg</span><span class="p">)));</span>
        <span class="p">}</span>
        <span class="k">switch</span> <span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span> <span class="p">{</span>
          <span class="k">case</span> <span class="s1">&#39;b&#39;</span><span class="o">:</span> <span class="nx">arg</span> <span class="o">=</span> <span class="nx">arg</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
          <span class="k">case</span> <span class="s1">&#39;c&#39;</span><span class="o">:</span> <span class="nx">arg</span> <span class="o">=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">arg</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
          <span class="k">case</span> <span class="s1">&#39;d&#39;</span><span class="o">:</span> <span class="nx">arg</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">arg</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
          <span class="k">case</span> <span class="s1">&#39;e&#39;</span><span class="o">:</span> <span class="nx">arg</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">?</span> <span class="nx">arg</span><span class="p">.</span><span class="nx">toExponential</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span> <span class="o">:</span> <span class="nx">arg</span><span class="p">.</span><span class="nx">toExponential</span><span class="p">();</span> <span class="k">break</span><span class="p">;</span>
          <span class="k">case</span> <span class="s1">&#39;f&#39;</span><span class="o">:</span> <span class="nx">arg</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">?</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">arg</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span> <span class="o">:</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">arg</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
          <span class="k">case</span> <span class="s1">&#39;o&#39;</span><span class="o">:</span> <span class="nx">arg</span> <span class="o">=</span> <span class="nx">arg</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
          <span class="k">case</span> <span class="s1">&#39;s&#39;</span><span class="o">:</span> <span class="nx">arg</span> <span class="o">=</span> <span class="p">((</span><span class="nx">arg</span> <span class="o">=</span> <span class="nb">String</span><span class="p">(</span><span class="nx">arg</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="nx">match</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">?</span> <span class="nx">arg</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">match</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span> <span class="o">:</span> <span class="nx">arg</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
          <span class="k">case</span> <span class="s1">&#39;u&#39;</span><span class="o">:</span> <span class="nx">arg</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">arg</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
          <span class="k">case</span> <span class="s1">&#39;x&#39;</span><span class="o">:</span> <span class="nx">arg</span> <span class="o">=</span> <span class="nx">arg</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
          <span class="k">case</span> <span class="s1">&#39;X&#39;</span><span class="o">:</span> <span class="nx">arg</span> <span class="o">=</span> <span class="nx">arg</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">).</span><span class="nx">toUpperCase</span><span class="p">();</span> <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">arg</span> <span class="o">=</span> <span class="p">(</span><span class="sr">/[def]/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nx">match</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">arg</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">?</span> <span class="s1">&#39;+&#39;</span><span class="o">+</span> <span class="nx">arg</span> <span class="o">:</span> <span class="nx">arg</span><span class="p">);</span>
        <span class="nx">pad_character</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">?</span> <span class="nx">match</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span> <span class="o">?</span> <span class="s1">&#39;0&#39;</span> <span class="o">:</span> <span class="nx">match</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="s1">&#39; &#39;</span><span class="p">;</span>
        <span class="nx">pad_length</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">-</span> <span class="nb">String</span><span class="p">(</span><span class="nx">arg</span><span class="p">).</span><span class="nx">length</span><span class="p">;</span>
        <span class="nx">pad</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">?</span> <span class="nx">str_repeat</span><span class="p">(</span><span class="nx">pad_character</span><span class="p">,</span> <span class="nx">pad_length</span><span class="p">)</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
        <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">?</span> <span class="nx">arg</span> <span class="o">+</span> <span class="nx">pad</span> <span class="o">:</span> <span class="nx">pad</span> <span class="o">+</span> <span class="nx">arg</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">output</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">str_format</span><span class="p">.</span><span class="nx">cache</span> <span class="o">=</span> <span class="p">{};</span>

  <span class="nx">str_format</span><span class="p">.</span><span class="nx">parse</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fmt</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_fmt</span> <span class="o">=</span> <span class="nx">fmt</span><span class="p">,</span> <span class="nx">match</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">parse_tree</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">arg_names</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">_fmt</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">((</span><span class="nx">match</span> <span class="o">=</span> <span class="sr">/^[^\x25]+/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">_fmt</span><span class="p">))</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">parse_tree</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="nx">match</span> <span class="o">=</span> <span class="sr">/^\x25{2}/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">_fmt</span><span class="p">))</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">parse_tree</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="nx">match</span> <span class="o">=</span> <span class="sr">/^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|&#39;[^$])?(-)?(\d+)?(?:\.(\d+))?([b-fosuxX])/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">_fmt</span><span class="p">))</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span>
          <span class="nx">arg_names</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">field_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">replacement_field</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">field_match</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="k">if</span> <span class="p">((</span><span class="nx">field_match</span> <span class="o">=</span> <span class="sr">/^([a-z_][a-z_\d]*)/i</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">replacement_field</span><span class="p">))</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">field_list</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">field_match</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
            <span class="k">while</span> <span class="p">((</span><span class="nx">replacement_field</span> <span class="o">=</span> <span class="nx">replacement_field</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">field_match</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">))</span> <span class="o">!==</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">if</span> <span class="p">((</span><span class="nx">field_match</span> <span class="o">=</span> <span class="sr">/^\.([a-z_][a-z_\d]*)/i</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">replacement_field</span><span class="p">))</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">field_list</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">field_match</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
              <span class="p">}</span>
              <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="nx">field_match</span> <span class="o">=</span> <span class="sr">/^\[(\d+)\]/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">replacement_field</span><span class="p">))</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">field_list</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">field_match</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
              <span class="p">}</span>
              <span class="k">else</span> <span class="p">{</span>
                <span class="k">throw</span><span class="p">(</span><span class="s1">&#39;[sprintf] huh?&#39;</span><span class="p">);</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span><span class="p">(</span><span class="s1">&#39;[sprintf] huh?&#39;</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nx">field_list</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
          <span class="nx">arg_names</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">arg_names</span> <span class="o">===</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">throw</span><span class="p">(</span><span class="s1">&#39;[sprintf] mixing positional and named placeholders is not (yet) supported&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">parse_tree</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">match</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="k">throw</span><span class="p">(</span><span class="s1">&#39;[sprintf] huh?&#39;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">_fmt</span> <span class="o">=</span> <span class="nx">_fmt</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">parse_tree</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">str_format</span><span class="p">;</span>
<span class="p">})();</span>

<span class="kd">var</span> <span class="nx">vsprintf</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fmt</span><span class="p">,</span> <span class="nx">argv</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">argv</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">fmt</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">sprintf</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">argv</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">sprintf</span> <span class="o">=</span> <span class="nx">sprintf</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">vsprintf</span> <span class="o">=</span> <span class="nx">vsprintf</span><span class="p">;</span>
<span class="p">});</span>

<span class="nx">require</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s2">&quot;/shred/response.js&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span> <span class="nx">exports</span><span class="p">,</span> <span class="nx">__dirname</span><span class="p">,</span> <span class="nx">__filename</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-94" id="section-94">&#182;</a>
</div>
<p>The <code>Response object</code> encapsulates a Node.js HTTP response.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="kd">var</span> <span class="nx">Content</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./content&quot;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">HeaderMixins</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./mixins/headers&quot;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">CookieJarLib</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span> <span class="s2">&quot;cookiejar&quot;</span> <span class="p">)</span>
  <span class="p">,</span> <span class="nx">Cookie</span> <span class="o">=</span> <span class="nx">CookieJarLib</span><span class="p">.</span><span class="nx">Cookie</span>
<span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-95" id="section-95">&#182;</a>
</div>
<p>Browser doesn't have zlib.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">var</span> <span class="nx">zlib</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="k">try</span> <span class="p">{</span>
  <span class="nx">zlib</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;zlib&#39;</span><span class="p">);</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&quot;no zlib library&quot;</span><span class="p">);</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-96" id="section-96">&#182;</a>
</div>
<p>Iconv doesn't work in browser</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">var</span> <span class="nx">Iconv</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="k">try</span> <span class="p">{</span>
  <span class="nx">Iconv</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;iconv-lite&#39;</span><span class="p">);</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&quot;no iconv library&quot;</span><span class="p">);</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-97" id="section-97">&#182;</a>
</div>
<p>Construct a <code>Response</code> object. You should never have to do this directly. The
<code>Request</code> object handles this, getting the raw response object and passing it
in here, along with the request. The callback allows us to stream the response
and then use the callback to let the request know when it's ready.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">var</span> <span class="nx">Response</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">raw</span><span class="p">,</span> <span class="nx">request</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span> 
  <span class="kd">var</span> <span class="nx">response</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_raw</span> <span class="o">=</span> <span class="nx">raw</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-98" id="section-98">&#182;</a>
</div>
<p>The <code>._setHeaders</code> method is "private"; you can't otherwise set headers on
the response.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">this</span><span class="p">.</span><span class="nx">_setHeaders</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">raw</span><span class="p">.</span><span class="nx">headers</span><span class="p">);</span>
  

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-99" id="section-99">&#182;</a>
</div>
<p>store any cookies</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">cookieJar</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">getHeader</span><span class="p">(</span><span class="s1">&#39;set-cookie&#39;</span><span class="p">))</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">cookieStrings</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getHeader</span><span class="p">(</span><span class="s1">&#39;set-cookie&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">cookieObjs</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="p">,</span> <span class="nx">cookie</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">cookieStrings</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">cookieString</span> <span class="o">=</span> <span class="nx">cookieStrings</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">cookieString</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">cookieString</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/domain\=/i</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">cookieString</span> <span class="o">+=</span> <span class="s1">&#39;; domain=&#39;</span> <span class="o">+</span> <span class="nx">request</span><span class="p">.</span><span class="nx">host</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">cookieString</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/path\=/i</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">cookieString</span> <span class="o">+=</span> <span class="s1">&#39;; path=&#39;</span> <span class="o">+</span> <span class="nx">request</span><span class="p">.</span><span class="nx">path</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">try</span> <span class="p">{</span>
        <span class="nx">cookie</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Cookie</span><span class="p">(</span><span class="nx">cookieString</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">cookie</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">cookieObjs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">cookie</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&quot;Tried to set bad cookie: &quot;</span> <span class="o">+</span> <span class="nx">cookieString</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">request</span><span class="p">.</span><span class="nx">cookieJar</span><span class="p">.</span><span class="nx">setCookies</span><span class="p">(</span><span class="nx">cookieObjs</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">request</span> <span class="o">=</span> <span class="nx">request</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">client</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">client</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">log</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">log</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-100" id="section-100">&#182;</a>
</div>
<p>Stream the response content entity and fire the callback when we're done.
Store the incoming data in a array of Buffers which we concatinate into one
buffer at the end.  We need to use buffers instead of strings here in order
to preserve binary data.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">chunkBuffers</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kd">var</span> <span class="nx">dataLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nx">raw</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">chunkBuffers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">chunk</span><span class="p">);</span>
    <span class="nx">dataLength</span> <span class="o">+=</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
  <span class="p">});</span>
  <span class="nx">raw</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">body</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">Buffer</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-101" id="section-101">&#182;</a>
</div>
<p>Just concatinate into a string</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">body</span> <span class="o">=</span> <span class="nx">chunkBuffers</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-102" id="section-102">&#182;</a>
</div>
<p>Initialize new buffer and add the chunks one-at-a-time.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">body</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">dataLength</span><span class="p">);</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">chunkBuffers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">chunkBuffers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">copy</span><span class="p">(</span><span class="nx">body</span><span class="p">,</span> <span class="nx">pos</span><span class="p">);</span>
        <span class="nx">pos</span> <span class="o">+=</span> <span class="nx">chunkBuffers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">setBodyAndFinish</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">_body</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Content</span><span class="p">({</span> 
        <span class="nx">body</span><span class="o">:</span> <span class="nx">body</span><span class="p">,</span>
        <span class="nx">type</span><span class="o">:</span> <span class="nx">response</span><span class="p">.</span><span class="nx">getHeader</span><span class="p">(</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">)</span>
      <span class="p">});</span>
      <span class="nx">callback</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">zlib</span> <span class="o">&amp;&amp;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">getHeader</span><span class="p">(</span><span class="s2">&quot;Content-Encoding&quot;</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;gzip&#39;</span><span class="p">){</span>
      <span class="nx">zlib</span><span class="p">.</span><span class="nx">gunzip</span><span class="p">(</span><span class="nx">body</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">gunzippedBody</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">Iconv</span> <span class="o">&amp;&amp;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">encoding</span><span class="p">){</span>
          <span class="nx">body</span> <span class="o">=</span> <span class="nx">Iconv</span><span class="p">.</span><span class="nx">fromEncoding</span><span class="p">(</span><span class="nx">gunzippedBody</span><span class="p">,</span><span class="nx">response</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">encoding</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">body</span> <span class="o">=</span> <span class="nx">gunzippedBody</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="nx">setBodyAndFinish</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>
      <span class="p">})</span>
    <span class="p">}</span>
    <span class="k">else</span><span class="p">{</span>
       <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">encoding</span><span class="p">){</span>
            <span class="nx">body</span> <span class="o">=</span> <span class="nx">Iconv</span><span class="p">.</span><span class="nx">fromEncoding</span><span class="p">(</span><span class="nx">body</span><span class="p">,</span><span class="nx">response</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">encoding</span><span class="p">);</span>
        <span class="p">}</span>        
      <span class="nx">setBodyAndFinish</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-103" id="section-103">&#182;</a>
</div>
<p>The <code>Response</code> object can be pretty overwhelming to view using the built-in
Node.js inspect method. We want to make it a bit more manageable. This
probably goes <a href="https://github.com/spire-io/shred/issues/2">too far in the other
direction</a>.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="nx">Response</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">inspect</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">response</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">headers</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">format_headers</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">summary</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&lt;Shred Response&gt; &quot;</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span> <span class="nx">summary</span><span class="p">,</span> <span class="s2">&quot;- Headers:&quot;</span><span class="p">,</span> <span class="nx">headers</span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">format_headers</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">array</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="kd">var</span> <span class="nx">headers</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_headers</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">headers</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">headers</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">headers</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
        <span class="nx">array</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;\t&quot;</span> <span class="o">+</span> <span class="nx">key</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="nx">value</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">array</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-104" id="section-104">&#182;</a>
</div>
<p><code>Response</code> object properties, all of which are read-only:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperties</span><span class="p">(</span><span class="nx">Response</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span>
  

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-105" id="section-105">&#182;</a>
</div>
<ul>
<li><strong>status</strong>. The HTTP status code for the response. </li>
</ul>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nx">status</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_raw</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">;</span> <span class="p">},</span>
    <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">},</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-106" id="section-106">&#182;</a>
</div>
<ul>
<li><strong>content</strong>. The HTTP content entity, if any. Provided as a <a href="./content.html">content
object</a>, which will attempt to convert the entity based upon
the <code>content-type</code> header. The converted value is available as
<code>content.data</code>. The original raw content entity is available as
<code>content.body</code>.</li>
</ul>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nx">body</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_body</span><span class="p">;</span> <span class="p">}</span>
  <span class="p">},</span>
  <span class="nx">content</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span> <span class="p">},</span>
    <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">},</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-107" id="section-107">&#182;</a>
</div>
<ul>
<li><strong>isRedirect</strong>. Is the response a redirect? These are responses with 3xx
status and a <code>Location</code> header.</li>
</ul>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nx">isRedirect</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">status</span><span class="o">&gt;</span><span class="mi">299</span>
          <span class="o">&amp;&amp;</span><span class="k">this</span><span class="p">.</span><span class="nx">status</span><span class="o">&lt;</span><span class="mi">400</span>
          <span class="o">&amp;&amp;</span><span class="k">this</span><span class="p">.</span><span class="nx">getHeader</span><span class="p">(</span><span class="s2">&quot;Location&quot;</span><span class="p">));</span>
    <span class="p">},</span>
    <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">},</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-108" id="section-108">&#182;</a>
</div>
<ul>
<li><strong>isError</strong>. Is the response an error? These are responses with status of
400 or greater.</li>
</ul>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nx">isError</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">&gt;</span> <span class="mi">399</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">}</span>
<span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-109" id="section-109">&#182;</a>
</div>
<p>Add in the <a href="./headers.js">getters for accessing the normalized headers</a>.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">HeaderMixins</span><span class="p">.</span><span class="nx">getters</span><span class="p">(</span><span class="nx">Response</span><span class="p">);</span>
<span class="nx">HeaderMixins</span><span class="p">.</span><span class="nx">privateSetters</span><span class="p">(</span><span class="nx">Response</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-110" id="section-110">&#182;</a>
</div>
<p>Work around Mozilla bug #608735 [<a href='https://bugzil.la/608735'>https://bugzil.la/608735</a>], which causes
getAllResponseHeaders() to return {} if the response is a CORS request.
xhr.getHeader still works correctly.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">var</span> <span class="nx">getHeader</span> <span class="o">=</span> <span class="nx">Response</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getHeader</span><span class="p">;</span>
<span class="nx">Response</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getHeader</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="nx">getHeader</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">name</span><span class="p">)</span> <span class="o">||</span>
    <span class="p">(</span><span class="k">typeof</span> <span class="k">this</span><span class="p">.</span><span class="nx">_raw</span><span class="p">.</span><span class="nx">getHeader</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">_raw</span><span class="p">.</span><span class="nx">getHeader</span><span class="p">(</span><span class="nx">name</span><span class="p">)));</span>
<span class="p">};</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Response</span><span class="p">;</span>

<span class="p">});</span>

<span class="nx">require</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s2">&quot;/shred/content.js&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span> <span class="nx">exports</span><span class="p">,</span> <span class="nx">__dirname</span><span class="p">,</span> <span class="nx">__filename</span><span class="p">)</span> <span class="p">{</span>
    

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-111" id="section-111">&#182;</a>
</div>
<p>The purpose of the <code>Content</code> object is to abstract away the data conversions
to and from raw content entities as strings. For example, you want to be able
to pass in a Javascript object and have it be automatically converted into a
JSON string if the <code>content-type</code> is set to a JSON-based media type.
Conversely, you want to be able to transparently get back a Javascript object
in the response if the <code>content-type</code> is a JSON-based media-type.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-112" id="section-112">&#182;</a>
</div>
<p>One limitation of the current implementation is that it <a href="https://github.com/spire-io/shred/issues/5">assumes the <code>charset</code> is UTF-8</a>.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-113" id="section-113">&#182;</a>
</div>
<p>The <code>Content</code> constructor takes an options object, which <em>must</em> have either a
<code>body</code> or <code>data</code> property and <em>may</em> have a <code>type</code> property indicating the
media type. If there is no <code>type</code> attribute, a default will be inferred.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">var</span> <span class="nx">Content</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">Content</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-114" id="section-114">&#182;</a>
</div>
<p>Treat <code>toString()</code> as asking for the <code>content.body</code>. That is, the raw content entity.</p>


<div class="highlight"><pre><code><span class="nx">toString</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span> <span class="p">}</span>
</code></pre></div>



<p>Commented out, but I've forgotten why. :/</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="p">};</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-115" id="section-115">&#182;</a>
</div>
<p><code>Content</code> objects have the following attributes:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperties</span><span class="p">(</span><span class="nx">Content</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,{</span>
  

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-116" id="section-116">&#182;</a>
</div>
<ul>
<li><strong>type</strong>. Typically accessed as <code>content.type</code>, reflects the <code>content-type</code>
header associated with the request or response. If not passed as an options
to the constructor or set explicitly, it will infer the type the <code>data</code>
attribute, if possible, and, failing that, will default to <code>text/plain</code>.</li>
</ul>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nx">type</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_type</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_type</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_data</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">switch</span><span class="p">(</span><span class="k">typeof</span> <span class="k">this</span><span class="p">.</span><span class="nx">_data</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="s2">&quot;string&quot;</span><span class="o">:</span> <span class="k">return</span> <span class="s2">&quot;text/plain&quot;</span><span class="p">;</span>
            <span class="k">case</span> <span class="s2">&quot;object&quot;</span><span class="o">:</span> <span class="k">return</span> <span class="s2">&quot;application/json&quot;</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="s2">&quot;text/plain&quot;</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_type</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">},</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-117" id="section-117">&#182;</a>
</div>
<ul>
<li><strong>data</strong>. Typically accessed as <code>content.data</code>, reflects the content entity
converted into Javascript data. This can be a string, if the <code>type</code> is, say,
<code>text/plain</code>, but can also be a Javascript object. The conversion applied is
based on the <code>processor</code> attribute. The <code>data</code> attribute can also be set
directly, in which case the conversion will be done the other way, to infer
the <code>body</code> attribute.</li>
</ul>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nx">data</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_body</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">processor</span><span class="p">.</span><span class="nx">parser</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_body</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_data</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_body</span><span class="o">&amp;&amp;</span><span class="nx">data</span><span class="p">)</span> <span class="nx">Errors</span><span class="p">.</span><span class="nx">setDataWithBody</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_data</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">},</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-118" id="section-118">&#182;</a>
</div>
<ul>
<li><strong>body</strong>. Typically accessed as <code>content.body</code>, reflects the content entity
as a UTF-8 string. It is the mirror of the <code>data</code> attribute. If you set the
<code>data</code> attribute, the <code>body</code> attribute will be inferred and vice-versa. If
you attempt to set both, an exception is raised.</li>
</ul>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nx">body</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">processor</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_data</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">processor</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_body</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_data</span><span class="o">&amp;&amp;</span><span class="nx">body</span><span class="p">)</span> <span class="nx">Errors</span><span class="p">.</span><span class="nx">setBodyWithData</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_body</span> <span class="o">=</span> <span class="nx">body</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">},</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-119" id="section-119">&#182;</a>
</div>
<ul>
<li><strong>processor</strong>. The functions that will be used to convert to/from <code>data</code> and
<code>body</code> attributes. You can add processors. The two that are built-in are for
<code>text/plain</code>, which is basically an identity transformation and
<code>application/json</code> and other JSON-based media types (including custom media
types with <code>+json</code>). You can add your own processors. See below.</li>
</ul>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nx">processor</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">processor</span> <span class="o">=</span> <span class="nx">Content</span><span class="p">.</span><span class="nx">processors</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">type</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">processor</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">processor</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-120" id="section-120">&#182;</a>
</div>
<p>Return the first processor that matches any part of the
content type. ex: application/vnd.foobar.baz+json will match json.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="kd">var</span> <span class="nx">main</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
        <span class="kd">var</span> <span class="nx">parts</span> <span class="o">=</span> <span class="nx">main</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\+|\//</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nx">l</span><span class="o">=</span><span class="nx">parts</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">processor</span> <span class="o">=</span> <span class="nx">Content</span><span class="p">.</span><span class="nx">processors</span><span class="p">[</span><span class="nx">parts</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">processor</span> <span class="o">||</span> <span class="p">{</span><span class="nx">parser</span><span class="o">:</span><span class="nx">identity</span><span class="p">,</span><span class="nx">stringify</span><span class="o">:</span><span class="nx">toString</span><span class="p">};</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">},</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-121" id="section-121">&#182;</a>
</div>
<ul>
<li><strong>length</strong>. Typically accessed as <code>content.length</code>, returns the length in
bytes of the raw content entity.</li>
</ul>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nx">length</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">Buffer</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">Buffer</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">Content</span><span class="p">.</span><span class="nx">processors</span> <span class="o">=</span> <span class="p">{};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-122" id="section-122">&#182;</a>
</div>
<p>The <code>registerProcessor</code> function allows you to add your own processors to
convert content entities. Each processor consists of a Javascript object with
two properties:
- <strong>parser</strong>. The function used to parse a raw content entity and convert it
  into a Javascript data type.
- <strong>stringify</strong>. The function used to convert a Javascript data type into a
  raw content entity.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">Content</span><span class="p">.</span><span class="nx">registerProcessor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">types</span><span class="p">,</span><span class="nx">processor</span><span class="p">)</span> <span class="p">{</span>
  

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-123" id="section-123">&#182;</a>
</div>
<p>You can pass an array of types that will trigger this processor, or just one.
We determine the array via duck-typing here.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">if</span> <span class="p">(</span><span class="nx">types</span><span class="p">.</span><span class="nx">forEach</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">types</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">Content</span><span class="p">.</span><span class="nx">processors</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span> <span class="o">=</span> <span class="nx">processor</span><span class="p">;</span>
    <span class="p">});</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-124" id="section-124">&#182;</a>
</div>
<p>If you didn't pass an array, we just use what you pass in.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Content</span><span class="p">.</span><span class="nx">processors</span><span class="p">[</span><span class="nx">types</span><span class="p">]</span> <span class="o">=</span> <span class="nx">processor</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-125" id="section-125">&#182;</a>
</div>
<p>Register the identity processor, which is used for text-based media types.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">var</span> <span class="nx">identity</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">x</span><span class="p">;</span> <span class="p">}</span>
  <span class="p">,</span> <span class="nx">toString</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">x</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span> <span class="p">}</span>
<span class="nx">Content</span><span class="p">.</span><span class="nx">registerProcessor</span><span class="p">(</span>
  <span class="p">[</span><span class="s2">&quot;text/html&quot;</span><span class="p">,</span><span class="s2">&quot;text/plain&quot;</span><span class="p">,</span><span class="s2">&quot;text&quot;</span><span class="p">],</span>
  <span class="p">{</span> <span class="nx">parser</span><span class="o">:</span> <span class="nx">identity</span><span class="p">,</span> <span class="nx">stringify</span><span class="o">:</span> <span class="nx">toString</span> <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-126" id="section-126">&#182;</a>
</div>
<p>Register the JSON processor, which is used for JSON-based media types.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">Content</span><span class="p">.</span><span class="nx">registerProcessor</span><span class="p">(</span>
  <span class="p">[</span><span class="s2">&quot;application/json; charset=utf-8&quot;</span><span class="p">,</span><span class="s2">&quot;application/json&quot;</span><span class="p">,</span><span class="s2">&quot;json&quot;</span><span class="p">],</span>
  <span class="p">{</span>
    <span class="nx">parser</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">string</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">stringify</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span> <span class="p">}});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-127" id="section-127">&#182;</a>
</div>
<p>Error functions are defined separately here in an attempt to make the code
easier to read.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">var</span> <span class="nx">Errors</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">setDataWithBody</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Attempt to set data attribute of a content object &quot;</span> <span class="o">+</span>
        <span class="s2">&quot;when the body attributes was already set.&quot;</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">setBodyWithData</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Attempt to set body attribute of a content object &quot;</span> <span class="o">+</span>
        <span class="s2">&quot;when the data attributes was already set.&quot;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Content</span><span class="p">;</span>

<span class="p">});</span>

<span class="nx">require</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s2">&quot;/shred/mixins/headers.js&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span> <span class="nx">exports</span><span class="p">,</span> <span class="nx">__dirname</span><span class="p">,</span> <span class="nx">__filename</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-128" id="section-128">&#182;</a>
</div>
<p>The header mixins allow you to add HTTP header support to any object. This
might seem pointless: why not simply use a hash? The main reason is that, per
the <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec4.html#sec4.2">HTTP spec</a>,
headers are case-insensitive. So, for example, <code>content-type</code> is the same as
<code>CONTENT-TYPE</code> which is the same as <code>Content-Type</code>. Since there is no way to
overload the index operator in Javascript, using a hash to represent the
headers means it's possible to have two conflicting values for a single
header.</p>

<p>The solution to this is to provide explicit methods to set or get headers.
This also has the benefit of allowing us to introduce additional variations,
including snake case, which we automatically convert to what Matthew King has
dubbed "corset case" - the hyphen-separated names with initial caps:
<code>Content-Type</code>. We use corset-case just in case we're dealing with servers
that haven't properly implemented the spec.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-129" id="section-129">&#182;</a>
</div>
<p>Convert headers to corset-case. <strong>Example:</strong> <code>CONTENT-TYPE</code> will be converted
to <code>Content-Type</code>.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="kd">var</span> <span class="nx">corsetCase</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">string</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-130" id="section-130">&#182;</a>
</div>
<p>.replace("_","-")</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/(^|-)(\w)/g</span><span class="p">,</span> 
          <span class="kd">function</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">();</span> <span class="p">});</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-131" id="section-131">&#182;</a>
</div>
<p>We suspect that <code>initializeHeaders</code> was once more complicated ...</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">var</span> <span class="nx">initializeHeaders</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{};</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-132" id="section-132">&#182;</a>
</div>
<p>Access the <code>_headers</code> property using lazy initialization. <strong>Warning:</strong> If you
mix this into an object that is using the <code>_headers</code> property already, you're
going to have trouble.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">var</span> <span class="nx">$H</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">object</span><span class="p">.</span><span class="nx">_headers</span><span class="o">||</span><span class="p">(</span><span class="nx">object</span><span class="p">.</span><span class="nx">_headers</span><span class="o">=</span><span class="nx">initializeHeaders</span><span class="p">(</span><span class="nx">object</span><span class="p">));</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-133" id="section-133">&#182;</a>
</div>
<p>Hide the implementations as private functions, separate from how we expose them.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-134" id="section-134">&#182;</a>
</div>
<p>The "real" <code>getHeader</code> function: get the header after normalizing the name.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">var</span> <span class="nx">getHeader</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">$H</span><span class="p">(</span><span class="nx">object</span><span class="p">)[</span><span class="nx">corsetCase</span><span class="p">(</span><span class="nx">name</span><span class="p">)];</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-135" id="section-135">&#182;</a>
</div>
<p>The "real" <code>getHeader</code> function: get one or more headers, or all of them
if you don't ask for any specifics. </p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">var</span> <span class="nx">getHeaders</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span><span class="nx">names</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="p">(</span><span class="nx">names</span> <span class="o">&amp;&amp;</span> <span class="nx">names</span><span class="p">.</span><span class="nx">length</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="nx">names</span> <span class="o">:</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">$H</span><span class="p">(</span><span class="nx">object</span><span class="p">));</span>
  <span class="kd">var</span> <span class="nx">hash</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">hash</span><span class="p">,</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">hash</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">getHeader</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span><span class="nx">key</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">hash</span><span class="p">;</span>
  <span class="p">},{});</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-136" id="section-136">&#182;</a>
</div>
<p>Freeze the resulting hash so you don't mistakenly think you're modifying
the real headers.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nb">Object</span><span class="p">.</span><span class="nx">freeze</span><span class="p">(</span><span class="nx">hash</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">hash</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-137" id="section-137">&#182;</a>
</div>
<p>The "real" <code>setHeader</code> function: set a header, after normalizing the name.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">var</span> <span class="nx">setHeader</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span><span class="nx">name</span><span class="p">,</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">$H</span><span class="p">(</span><span class="nx">object</span><span class="p">)[</span><span class="nx">corsetCase</span><span class="p">(</span><span class="nx">name</span><span class="p">)]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">object</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-138" id="section-138">&#182;</a>
</div>
<p>The "real" <code>setHeaders</code> function: set multiple headers based on a hash.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">var</span> <span class="nx">setHeaders</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span><span class="nx">hash</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span><span class="p">(</span> <span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">hash</span> <span class="p">)</span> <span class="p">{</span> <span class="nx">setHeader</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span><span class="nx">key</span><span class="p">,</span><span class="nx">hash</span><span class="p">[</span><span class="nx">key</span><span class="p">]);</span> <span class="p">};</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-139" id="section-139">&#182;</a>
</div>
<p>Here's where we actually bind the functionality to an object. These mixins work by
exposing mixin functions. Each function mixes in a specific batch of features.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-140" id="section-140">&#182;</a>
</div>
<p>Add getters.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nx">getters</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">constructor</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">constructor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getHeader</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">getHeader</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">name</span><span class="p">);</span> <span class="p">};</span>
    <span class="nx">constructor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getHeaders</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">getHeaders</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">arguments</span><span class="p">);</span> <span class="p">};</span>
  <span class="p">},</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-141" id="section-141">&#182;</a>
</div>
<p>Add setters but as "private" methods.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nx">privateSetters</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">constructor</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">constructor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_setHeader</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">setHeader</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">key</span><span class="p">,</span><span class="nx">value</span><span class="p">);</span> <span class="p">};</span>
    <span class="nx">constructor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_setHeaders</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">hash</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">setHeaders</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">hash</span><span class="p">);</span> <span class="p">};</span>
  <span class="p">},</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-142" id="section-142">&#182;</a>
</div>
<p>Add setters.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nx">setters</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">constructor</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">constructor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setHeader</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">setHeader</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">key</span><span class="p">,</span><span class="nx">value</span><span class="p">);</span> <span class="p">};</span>
    <span class="nx">constructor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setHeaders</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">hash</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">setHeaders</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">hash</span><span class="p">);</span> <span class="p">};</span>
  <span class="p">},</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-143" id="section-143">&#182;</a>
</div>
<p>Add both getters and setters.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nx">gettersAndSetters</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">constructor</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">constructor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getHeader</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">getHeader</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">name</span><span class="p">);</span> <span class="p">};</span>
    <span class="nx">constructor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getHeaders</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">getHeaders</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">arguments</span><span class="p">);</span> <span class="p">};</span>
    <span class="nx">constructor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setHeader</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">setHeader</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">key</span><span class="p">,</span><span class="nx">value</span><span class="p">);</span> <span class="p">};</span>
    <span class="nx">constructor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setHeaders</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">hash</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">setHeaders</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">hash</span><span class="p">);</span> <span class="p">};</span>
  <span class="p">},</span>
<span class="p">};</span>

<span class="p">});</span>

<span class="nx">require</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s2">&quot;/node_modules/iconv-lite/package.json&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span> <span class="nx">exports</span><span class="p">,</span> <span class="nx">__dirname</span><span class="p">,</span> <span class="nx">__filename</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{}</span>
<span class="p">});</span>

<span class="nx">require</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s2">&quot;/node_modules/iconv-lite/index.js&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span> <span class="nx">exports</span><span class="p">,</span> <span class="nx">__dirname</span><span class="p">,</span> <span class="nx">__filename</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-144" id="section-144">&#182;</a>
</div>
<p>Module exports</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">var</span> <span class="nx">iconv</span> <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">toEncoding</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="nx">encoding</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">iconv</span><span class="p">.</span><span class="nx">getCodec</span><span class="p">(</span><span class="nx">encoding</span><span class="p">).</span><span class="nx">toEncoding</span><span class="p">(</span><span class="nx">str</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">fromEncoding</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">buf</span><span class="p">,</span> <span class="nx">encoding</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">iconv</span><span class="p">.</span><span class="nx">getCodec</span><span class="p">(</span><span class="nx">encoding</span><span class="p">).</span><span class="nx">fromEncoding</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
    <span class="p">},</span>
    
    <span class="nx">defaultCharUnicode</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="nx">defaultCharSingleByte</span><span class="o">:</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span>
    

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-145" id="section-145">&#182;</a>
</div>
<p>Get correct codec for given encoding.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">getCodec</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">encoding</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">enc</span> <span class="o">=</span> <span class="nx">encoding</span> <span class="o">||</span> <span class="s2">&quot;utf8&quot;</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">codecOptions</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">getType</span><span class="p">(</span><span class="nx">enc</span><span class="p">)</span> <span class="o">===</span> <span class="s2">&quot;String&quot;</span><span class="p">)</span>
                <span class="nx">enc</span> <span class="o">=</span> <span class="nx">enc</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[- ]/g</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">();</span>
            <span class="kd">var</span> <span class="nx">codec</span> <span class="o">=</span> <span class="nx">iconv</span><span class="p">.</span><span class="nx">encodings</span><span class="p">[</span><span class="nx">enc</span><span class="p">];</span>
            <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">getType</span><span class="p">(</span><span class="nx">codec</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;String&quot;</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-146" id="section-146">&#182;</a>
</div>
<p>Link to other encoding.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="nx">codecOptions</span> <span class="o">=</span> <span class="p">{</span><span class="nx">originalEncoding</span><span class="o">:</span> <span class="nx">enc</span><span class="p">};</span>
                <span class="nx">enc</span> <span class="o">=</span> <span class="nx">codec</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;Object&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">codec</span><span class="p">.</span><span class="nx">type</span> <span class="o">!=</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-147" id="section-147">&#182;</a>
</div>
<p>Options for other encoding.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="nx">codecOptions</span> <span class="o">=</span> <span class="nx">codec</span><span class="p">;</span>
                <span class="nx">enc</span> <span class="o">=</span> <span class="nx">codec</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>
            <span class="p">}</span> 
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;Function&quot;</span><span class="p">)</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-148" id="section-148">&#182;</a>
</div>
<p>Codec itself.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="k">return</span> <span class="nx">codec</span><span class="p">(</span><span class="nx">codecOptions</span><span class="p">);</span>
            <span class="k">else</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Encoding not recognized: &#39;&quot;</span> <span class="o">+</span> <span class="nx">encoding</span> <span class="o">+</span> <span class="s2">&quot;&#39; (searched as: &#39;&quot;</span><span class="o">+</span><span class="nx">enc</span><span class="o">+</span><span class="s2">&quot;&#39;)&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">},</span>
    

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-149" id="section-149">&#182;</a>
</div>
<p>Define basic encodings</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">encodings</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">internal</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="nx">toEncoding</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">ensureString</span><span class="p">(</span><span class="nx">str</span><span class="p">),</span> <span class="nx">options</span><span class="p">.</span><span class="nx">originalEncoding</span><span class="p">);</span>
                <span class="p">},</span>
                <span class="nx">fromEncoding</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">ensureBuffer</span><span class="p">(</span><span class="nx">buf</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">originalEncoding</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">};</span>
        <span class="p">},</span>
        <span class="nx">utf8</span><span class="o">:</span> <span class="s2">&quot;internal&quot;</span><span class="p">,</span>
        <span class="nx">ucs2</span><span class="o">:</span> <span class="s2">&quot;internal&quot;</span><span class="p">,</span>
        <span class="nx">binary</span><span class="o">:</span> <span class="s2">&quot;internal&quot;</span><span class="p">,</span>
        <span class="nx">ascii</span><span class="o">:</span> <span class="s2">&quot;internal&quot;</span><span class="p">,</span>
        <span class="nx">base64</span><span class="o">:</span> <span class="s2">&quot;internal&quot;</span><span class="p">,</span>
        

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-150" id="section-150">&#182;</a>
</div>
<p>Codepage single-byte encodings.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">singlebyte</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-151" id="section-151">&#182;</a>
</div>
<p>Prepare chars if needed</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">chars</span> <span class="o">||</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">chars</span><span class="p">.</span><span class="nx">length</span> <span class="o">!==</span> <span class="mi">128</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">chars</span><span class="p">.</span><span class="nx">length</span> <span class="o">!==</span> <span class="mi">256</span><span class="p">))</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Encoding &#39;&quot;</span><span class="o">+</span><span class="nx">options</span><span class="p">.</span><span class="nx">type</span><span class="o">+</span><span class="s2">&quot;&#39; has incorrect &#39;chars&#39; (must be of len 128 or 256)&quot;</span><span class="p">);</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">chars</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">128</span><span class="p">)</span>
                <span class="nx">options</span><span class="p">.</span><span class="nx">chars</span> <span class="o">=</span> <span class="nx">asciiString</span> <span class="o">+</span> <span class="nx">options</span><span class="p">.</span><span class="nx">chars</span><span class="p">;</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">charsBuf</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">options</span><span class="p">.</span><span class="nx">charsBuf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">chars</span><span class="p">,</span> <span class="s1">&#39;ucs2&#39;</span><span class="p">);</span>
            <span class="p">}</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">revCharsBuf</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">options</span><span class="p">.</span><span class="nx">revCharsBuf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="mi">65536</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">defChar</span> <span class="o">=</span> <span class="nx">iconv</span><span class="p">.</span><span class="nx">defaultCharSingleByte</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
                <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">revCharsBuf</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
                    <span class="nx">options</span><span class="p">.</span><span class="nx">revCharsBuf</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">defChar</span><span class="p">;</span>
                <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">chars</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
                    <span class="nx">options</span><span class="p">.</span><span class="nx">revCharsBuf</span><span class="p">[</span><span class="nx">options</span><span class="p">.</span><span class="nx">chars</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">)]</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
            <span class="p">}</span>
            
            <span class="k">return</span> <span class="p">{</span>
                <span class="nx">toEncoding</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">str</span> <span class="o">=</span> <span class="nx">ensureString</span><span class="p">(</span><span class="nx">str</span><span class="p">);</span>
                    
                    <span class="kd">var</span> <span class="nx">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">str</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
                    <span class="kd">var</span> <span class="nx">revCharsBuf</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">revCharsBuf</span><span class="p">;</span>
                    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">str</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
                        <span class="nx">buf</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">revCharsBuf</span><span class="p">[</span><span class="nx">str</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">)];</span>
                    
                    <span class="k">return</span> <span class="nx">buf</span><span class="p">;</span>
                <span class="p">},</span>
                <span class="nx">fromEncoding</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">buf</span> <span class="o">=</span> <span class="nx">ensureBuffer</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
                    

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-152" id="section-152">&#182;</a>
</div>
<p>Strings are immutable in JS -> we use ucs2 buffer to speed up computations.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                    <span class="kd">var</span> <span class="nx">charsBuf</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">charsBuf</span><span class="p">;</span>
                    <span class="kd">var</span> <span class="nx">newBuf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">buf</span><span class="p">.</span><span class="nx">length</span><span class="o">*</span><span class="mi">2</span><span class="p">);</span>
                    <span class="kd">var</span> <span class="nx">idx1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">idx2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">_len</span> <span class="o">=</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">_len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">idx1</span> <span class="o">=</span> <span class="nx">buf</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span> <span class="nx">idx2</span> <span class="o">=</span> <span class="nx">i</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>
                        <span class="nx">newBuf</span><span class="p">[</span><span class="nx">idx2</span><span class="p">]</span> <span class="o">=</span> <span class="nx">charsBuf</span><span class="p">[</span><span class="nx">idx1</span><span class="p">];</span>
                        <span class="nx">newBuf</span><span class="p">[</span><span class="nx">idx2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">charsBuf</span><span class="p">[</span><span class="nx">idx1</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
                    <span class="p">}</span>
                    <span class="k">return</span> <span class="nx">newBuf</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;ucs2&#39;</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">};</span>
        <span class="p">},</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-153" id="section-153">&#182;</a>
</div>
<p>Codepage double-byte encodings.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">table</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">table</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">table</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">revCharsTable</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">revCharsTable</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">table</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Encoding &#39;&quot;</span> <span class="o">+</span> <span class="nx">options</span><span class="p">.</span><span class="nx">type</span> <span class="o">+</span><span class="s2">&quot;&#39; has incorect &#39;table&#39; option&quot;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">revCharsTable</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">revCharsTable</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">revCharsTable</span> <span class="o">=</span> <span class="p">{};</span>
                <span class="k">for</span> <span class="p">(</span><span class="nx">key</span> <span class="k">in</span> <span class="nx">table</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">revCharsTable</span><span class="p">[</span><span class="nx">table</span><span class="p">[</span><span class="nx">key</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
            
            <span class="k">return</span> <span class="p">{</span>
                <span class="nx">toEncoding</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">str</span> <span class="o">=</span> <span class="nx">ensureString</span><span class="p">(</span><span class="nx">str</span><span class="p">);</span>
                    <span class="kd">var</span> <span class="nx">strLen</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
                    <span class="kd">var</span> <span class="nx">bufLen</span> <span class="o">=</span> <span class="nx">strLen</span><span class="p">;</span>
                    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">strLen</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">str</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span>
                            <span class="nx">bufLen</span><span class="o">++</span><span class="p">;</span>

                    <span class="kd">var</span> <span class="nx">newBuf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">bufLen</span><span class="p">),</span> <span class="nx">gbkcode</span><span class="p">,</span> <span class="nx">unicode</span><span class="p">,</span> 
                        <span class="nx">defaultChar</span> <span class="o">=</span> <span class="nx">revCharsTable</span><span class="p">[</span><span class="nx">iconv</span><span class="p">.</span><span class="nx">defaultCharUnicode</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)];</span>

                    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">strLen</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">unicode</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">unicode</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">gbkcode</span> <span class="o">=</span> <span class="nx">revCharsTable</span><span class="p">[</span><span class="nx">unicode</span><span class="p">]</span> <span class="o">||</span> <span class="nx">defaultChar</span><span class="p">;</span>
                            <span class="nx">newBuf</span><span class="p">[</span><span class="nx">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">gbkcode</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span> <span class="c1">//high byte;</span>
                            <span class="nx">newBuf</span><span class="p">[</span><span class="nx">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">gbkcode</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span> <span class="c1">//low byte</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span><span class="c1">//ascii</span>
                            <span class="nx">newBuf</span><span class="p">[</span><span class="nx">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">unicode</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                    <span class="k">return</span> <span class="nx">newBuf</span><span class="p">;</span>
                <span class="p">},</span>
                <span class="nx">fromEncoding</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">buf</span> <span class="o">=</span> <span class="nx">ensureBuffer</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
                    <span class="kd">var</span> <span class="nx">bufLen</span> <span class="o">=</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">strLen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">bufLen</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">strLen</span><span class="o">++</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">buf</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="c1">//the high bit is 1, so this byte is gbkcode&#39;s high byte.skip next byte</span>
                            <span class="nx">i</span><span class="o">++</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="kd">var</span> <span class="nx">newBuf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">strLen</span><span class="o">*</span><span class="mi">2</span><span class="p">),</span> <span class="nx">unicode</span><span class="p">,</span> <span class="nx">gbkcode</span><span class="p">,</span>
                        <span class="nx">defaultChar</span> <span class="o">=</span> <span class="nx">iconv</span><span class="p">.</span><span class="nx">defaultCharUnicode</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
                    
                    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">bufLen</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">,</span> <span class="nx">j</span><span class="o">+=</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">gbkcode</span> <span class="o">=</span> <span class="nx">buf</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">gbkcode</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">gbkcode</span> <span class="o">=</span> <span class="p">(</span><span class="nx">gbkcode</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="nx">buf</span><span class="p">[</span><span class="o">++</span><span class="nx">i</span><span class="p">];</span>
                            <span class="nx">unicode</span> <span class="o">=</span> <span class="nx">table</span><span class="p">[</span><span class="nx">gbkcode</span><span class="p">]</span> <span class="o">||</span> <span class="nx">defaultChar</span><span class="p">;</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="nx">unicode</span> <span class="o">=</span> <span class="nx">gbkcode</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="nx">newBuf</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="o">=</span> <span class="nx">unicode</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span> <span class="c1">//low byte</span>
                        <span class="nx">newBuf</span><span class="p">[</span><span class="nx">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">unicode</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span> <span class="c1">//high byte</span>
                    <span class="p">}</span>
                    <span class="k">return</span> <span class="nx">newBuf</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;ucs2&#39;</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-154" id="section-154">&#182;</a>
</div>
<p>Add aliases to convert functions</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">iconv</span><span class="p">.</span><span class="nx">encode</span> <span class="o">=</span> <span class="nx">iconv</span><span class="p">.</span><span class="nx">toEncoding</span><span class="p">;</span>
<span class="nx">iconv</span><span class="p">.</span><span class="nx">decode</span> <span class="o">=</span> <span class="nx">iconv</span><span class="p">.</span><span class="nx">fromEncoding</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-155" id="section-155">&#182;</a>
</div>
<p>Load other encodings from files in /encodings dir.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">var</span> <span class="nx">encodingsDir</span> <span class="o">=</span> <span class="nx">__dirname</span><span class="o">+</span><span class="s2">&quot;/encodings/&quot;</span><span class="p">,</span>
    <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">);</span>
<span class="nx">fs</span><span class="p">.</span><span class="nx">readdirSync</span><span class="p">(</span><span class="nx">encodingsDir</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">statSync</span><span class="p">(</span><span class="nx">encodingsDir</span> <span class="o">+</span> <span class="nx">file</span><span class="p">).</span><span class="nx">isDirectory</span><span class="p">())</span> <span class="k">return</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">encodings</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">encodingsDir</span> <span class="o">+</span> <span class="nx">file</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">encodings</span><span class="p">)</span>
        <span class="nx">iconv</span><span class="p">.</span><span class="nx">encodings</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">encodings</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
<span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-156" id="section-156">&#182;</a>
</div>
<p>Utilities</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">var</span> <span class="nx">asciiString</span> <span class="o">=</span> <span class="s1">&#39;\x00\x01\x02\x03\x04\x05\x06\x07\x08\t\n\x0b\x0c\r\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f&#39;</span><span class="o">+</span>
              <span class="s1">&#39; !&quot;#$%&amp;\&#39;()*+,-./0123456789:;&lt;=&gt;?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~\x7f&#39;</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">ensureBuffer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">buf</span> <span class="o">=</span> <span class="nx">buf</span> <span class="o">||</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">buf</span> <span class="k">instanceof</span> <span class="nx">Buffer</span><span class="p">)</span> <span class="o">?</span> <span class="nx">buf</span> <span class="o">:</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">buf</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span> <span class="s2">&quot;utf8&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">ensureString</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">str</span> <span class="o">=</span> <span class="nx">str</span> <span class="o">||</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">str</span> <span class="k">instanceof</span> <span class="nb">String</span><span class="p">)</span> <span class="o">?</span> <span class="nx">str</span> <span class="o">:</span> <span class="nx">str</span><span class="p">.</span><span class="nx">toString</span><span class="p">((</span><span class="nx">str</span> <span class="k">instanceof</span> <span class="nx">Buffer</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;utf8&#39;</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">getType</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">obj</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>


<span class="p">});</span>

<span class="nx">require</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s2">&quot;/node_modules/http-browserify/package.json&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span> <span class="nx">exports</span><span class="p">,</span> <span class="nx">__dirname</span><span class="p">,</span> <span class="nx">__filename</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;main&quot;</span><span class="o">:</span><span class="s2">&quot;index.js&quot;</span><span class="p">,</span><span class="s2">&quot;browserify&quot;</span><span class="o">:</span><span class="s2">&quot;browser.js&quot;</span><span class="p">}</span>
<span class="p">});</span>

<span class="nx">require</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s2">&quot;/node_modules/http-browserify/browser.js&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span> <span class="nx">exports</span><span class="p">,</span> <span class="nx">__dirname</span><span class="p">,</span> <span class="nx">__filename</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">EventEmitter</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;events&#39;</span><span class="p">).</span><span class="nx">EventEmitter</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">Request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/request&#39;</span><span class="p">);</span>

<span class="nx">http</span><span class="p">.</span><span class="nx">request</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">params</span><span class="p">)</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">params</span><span class="p">.</span><span class="nx">host</span><span class="p">)</span> <span class="nx">params</span><span class="p">.</span><span class="nx">host</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">host</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">params</span><span class="p">.</span><span class="nx">port</span><span class="p">)</span> <span class="nx">params</span><span class="p">.</span><span class="nx">port</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">port</span><span class="p">;</span>
    
    <span class="kd">var</span> <span class="nx">req</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Request</span><span class="p">(</span><span class="k">new</span> <span class="nx">xhrHttp</span><span class="p">,</span> <span class="nx">params</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="nx">req</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;response&#39;</span><span class="p">,</span> <span class="nx">cb</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">req</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">http</span><span class="p">.</span><span class="nx">get</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">params</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="s1">&#39;GET&#39;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">req</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="nx">cb</span><span class="p">);</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">req</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">xhrHttp</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nb">window</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;no window object present&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">XMLHttpRequest</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">window</span><span class="p">.</span><span class="nx">XMLHttpRequest</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">ActiveXObject</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">axs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;Msxml2.XMLHTTP.6.0&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Msxml2.XMLHTTP.3.0&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Microsoft.XMLHTTP&#39;</span>
        <span class="p">];</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">axs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">try</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">ax</span> <span class="o">=</span> <span class="k">new</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">ActiveXObject</span><span class="p">)(</span><span class="nx">axs</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
                <span class="k">return</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">ax</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">ax_</span> <span class="o">=</span> <span class="nx">ax</span><span class="p">;</span>
                        <span class="nx">ax</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                        <span class="k">return</span> <span class="nx">ax_</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">else</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="k">new</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">ActiveXObject</span><span class="p">)(</span><span class="nx">axs</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
                    <span class="p">}</span>
                <span class="p">};</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{}</span>
        <span class="p">}</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;ajax not supported in this browser&#39;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;ajax not supported in this browser&#39;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">})();</span>

<span class="nx">http</span><span class="p">.</span><span class="nx">STATUS_CODES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">100</span> <span class="o">:</span> <span class="s1">&#39;Continue&#39;</span><span class="p">,</span>
    <span class="mi">101</span> <span class="o">:</span> <span class="s1">&#39;Switching Protocols&#39;</span><span class="p">,</span>
    <span class="mi">102</span> <span class="o">:</span> <span class="s1">&#39;Processing&#39;</span><span class="p">,</span> <span class="c1">// RFC 2518, obsoleted by RFC 4918</span>
    <span class="mi">200</span> <span class="o">:</span> <span class="s1">&#39;OK&#39;</span><span class="p">,</span>
    <span class="mi">201</span> <span class="o">:</span> <span class="s1">&#39;Created&#39;</span><span class="p">,</span>
    <span class="mi">202</span> <span class="o">:</span> <span class="s1">&#39;Accepted&#39;</span><span class="p">,</span>
    <span class="mi">203</span> <span class="o">:</span> <span class="s1">&#39;Non-Authoritative Information&#39;</span><span class="p">,</span>
    <span class="mi">204</span> <span class="o">:</span> <span class="s1">&#39;No Content&#39;</span><span class="p">,</span>
    <span class="mi">205</span> <span class="o">:</span> <span class="s1">&#39;Reset Content&#39;</span><span class="p">,</span>
    <span class="mi">206</span> <span class="o">:</span> <span class="s1">&#39;Partial Content&#39;</span><span class="p">,</span>
    <span class="mi">207</span> <span class="o">:</span> <span class="s1">&#39;Multi-Status&#39;</span><span class="p">,</span> <span class="c1">// RFC 4918</span>
    <span class="mi">300</span> <span class="o">:</span> <span class="s1">&#39;Multiple Choices&#39;</span><span class="p">,</span>
    <span class="mi">301</span> <span class="o">:</span> <span class="s1">&#39;Moved Permanently&#39;</span><span class="p">,</span>
    <span class="mi">302</span> <span class="o">:</span> <span class="s1">&#39;Moved Temporarily&#39;</span><span class="p">,</span>
    <span class="mi">303</span> <span class="o">:</span> <span class="s1">&#39;See Other&#39;</span><span class="p">,</span>
    <span class="mi">304</span> <span class="o">:</span> <span class="s1">&#39;Not Modified&#39;</span><span class="p">,</span>
    <span class="mi">305</span> <span class="o">:</span> <span class="s1">&#39;Use Proxy&#39;</span><span class="p">,</span>
    <span class="mi">307</span> <span class="o">:</span> <span class="s1">&#39;Temporary Redirect&#39;</span><span class="p">,</span>
    <span class="mi">400</span> <span class="o">:</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span>
    <span class="mi">401</span> <span class="o">:</span> <span class="s1">&#39;Unauthorized&#39;</span><span class="p">,</span>
    <span class="mi">402</span> <span class="o">:</span> <span class="s1">&#39;Payment Required&#39;</span><span class="p">,</span>
    <span class="mi">403</span> <span class="o">:</span> <span class="s1">&#39;Forbidden&#39;</span><span class="p">,</span>
    <span class="mi">404</span> <span class="o">:</span> <span class="s1">&#39;Not Found&#39;</span><span class="p">,</span>
    <span class="mi">405</span> <span class="o">:</span> <span class="s1">&#39;Method Not Allowed&#39;</span><span class="p">,</span>
    <span class="mi">406</span> <span class="o">:</span> <span class="s1">&#39;Not Acceptable&#39;</span><span class="p">,</span>
    <span class="mi">407</span> <span class="o">:</span> <span class="s1">&#39;Proxy Authentication Required&#39;</span><span class="p">,</span>
    <span class="mi">408</span> <span class="o">:</span> <span class="s1">&#39;Request Time-out&#39;</span><span class="p">,</span>
    <span class="mi">409</span> <span class="o">:</span> <span class="s1">&#39;Conflict&#39;</span><span class="p">,</span>
    <span class="mi">410</span> <span class="o">:</span> <span class="s1">&#39;Gone&#39;</span><span class="p">,</span>
    <span class="mi">411</span> <span class="o">:</span> <span class="s1">&#39;Length Required&#39;</span><span class="p">,</span>
    <span class="mi">412</span> <span class="o">:</span> <span class="s1">&#39;Precondition Failed&#39;</span><span class="p">,</span>
    <span class="mi">413</span> <span class="o">:</span> <span class="s1">&#39;Request Entity Too Large&#39;</span><span class="p">,</span>
    <span class="mi">414</span> <span class="o">:</span> <span class="s1">&#39;Request-URI Too Large&#39;</span><span class="p">,</span>
    <span class="mi">415</span> <span class="o">:</span> <span class="s1">&#39;Unsupported Media Type&#39;</span><span class="p">,</span>
    <span class="mi">416</span> <span class="o">:</span> <span class="s1">&#39;Requested Range Not Satisfiable&#39;</span><span class="p">,</span>
    <span class="mi">417</span> <span class="o">:</span> <span class="s1">&#39;Expectation Failed&#39;</span><span class="p">,</span>
    <span class="mi">418</span> <span class="o">:</span> <span class="s1">&#39;I\&#39;m a teapot&#39;</span><span class="p">,</span> <span class="c1">// RFC 2324</span>
    <span class="mi">422</span> <span class="o">:</span> <span class="s1">&#39;Unprocessable Entity&#39;</span><span class="p">,</span> <span class="c1">// RFC 4918</span>
    <span class="mi">423</span> <span class="o">:</span> <span class="s1">&#39;Locked&#39;</span><span class="p">,</span> <span class="c1">// RFC 4918</span>
    <span class="mi">424</span> <span class="o">:</span> <span class="s1">&#39;Failed Dependency&#39;</span><span class="p">,</span> <span class="c1">// RFC 4918</span>
    <span class="mi">425</span> <span class="o">:</span> <span class="s1">&#39;Unordered Collection&#39;</span><span class="p">,</span> <span class="c1">// RFC 4918</span>
    <span class="mi">426</span> <span class="o">:</span> <span class="s1">&#39;Upgrade Required&#39;</span><span class="p">,</span> <span class="c1">// RFC 2817</span>
    <span class="mi">500</span> <span class="o">:</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span>
    <span class="mi">501</span> <span class="o">:</span> <span class="s1">&#39;Not Implemented&#39;</span><span class="p">,</span>
    <span class="mi">502</span> <span class="o">:</span> <span class="s1">&#39;Bad Gateway&#39;</span><span class="p">,</span>
    <span class="mi">503</span> <span class="o">:</span> <span class="s1">&#39;Service Unavailable&#39;</span><span class="p">,</span>
    <span class="mi">504</span> <span class="o">:</span> <span class="s1">&#39;Gateway Time-out&#39;</span><span class="p">,</span>
    <span class="mi">505</span> <span class="o">:</span> <span class="s1">&#39;HTTP Version not supported&#39;</span><span class="p">,</span>
    <span class="mi">506</span> <span class="o">:</span> <span class="s1">&#39;Variant Also Negotiates&#39;</span><span class="p">,</span> <span class="c1">// RFC 2295</span>
    <span class="mi">507</span> <span class="o">:</span> <span class="s1">&#39;Insufficient Storage&#39;</span><span class="p">,</span> <span class="c1">// RFC 4918</span>
    <span class="mi">509</span> <span class="o">:</span> <span class="s1">&#39;Bandwidth Limit Exceeded&#39;</span><span class="p">,</span>
    <span class="mi">510</span> <span class="o">:</span> <span class="s1">&#39;Not Extended&#39;</span> <span class="c1">// RFC 2774</span>
<span class="p">};</span>

<span class="p">});</span>

<span class="nx">require</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s2">&quot;/node_modules/http-browserify/lib/request.js&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span> <span class="nx">exports</span><span class="p">,</span> <span class="nx">__dirname</span><span class="p">,</span> <span class="nx">__filename</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">EventEmitter</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;events&#39;</span><span class="p">).</span><span class="nx">EventEmitter</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">Response</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./response&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">isSafeHeader</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./isSafeHeader&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">Request</span> <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">xhr</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">xhr</span> <span class="o">=</span> <span class="nx">xhr</span><span class="p">;</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    
    <span class="kd">var</span> <span class="nx">uri</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">host</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">params</span><span class="p">.</span><span class="nx">port</span> <span class="o">+</span> <span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">path</span> <span class="o">||</span> <span class="s1">&#39;/&#39;</span><span class="p">);</span>
    
    <span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span>
        <span class="nx">params</span><span class="p">.</span><span class="nx">method</span> <span class="o">||</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span>
        <span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">scheme</span> <span class="o">||</span> <span class="s1">&#39;http&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;://&#39;</span> <span class="o">+</span> <span class="nx">uri</span><span class="p">,</span>
        <span class="kc">true</span>
    <span class="p">);</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">headers</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">headers</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isSafeHeader</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">value</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">v</span><span class="p">);</span>
                <span class="p">});</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
        <span class="p">});</span>
    <span class="p">}</span>
    
    <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Response</span><span class="p">(</span><span class="nx">xhr</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;ready&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;response&#39;</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
    <span class="p">});</span>
    
    <span class="nx">xhr</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">handle</span><span class="p">(</span><span class="nx">xhr</span><span class="p">);</span>
    <span class="p">};</span>
<span class="p">};</span>

<span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EventEmitter</span><span class="p">;</span>

<span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setHeader</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">((</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span> <span class="o">&amp;&amp;</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span>
    <span class="o">||</span> <span class="nx">value</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">write</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">+=</span> <span class="nx">s</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">end</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">s</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">s</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
<span class="p">};</span>

<span class="p">});</span>

<span class="nx">require</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s2">&quot;/node_modules/http-browserify/lib/response.js&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span> <span class="nx">exports</span><span class="p">,</span> <span class="nx">__dirname</span><span class="p">,</span> <span class="nx">__filename</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">EventEmitter</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;events&#39;</span><span class="p">).</span><span class="nx">EventEmitter</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">isSafeHeader</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./isSafeHeader&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">Response</span> <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">xhr</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span> <span class="o">=</span> <span class="nx">xhr</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">Response</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EventEmitter</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">capable</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">streaming</span> <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nx">status2</span> <span class="o">:</span> <span class="kc">true</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">parseHeaders</span> <span class="p">(</span><span class="nx">xhr</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">lines</span> <span class="o">=</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">getAllResponseHeaders</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\r?\n/</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">headers</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">lines</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">line</span> <span class="o">=</span> <span class="nx">lines</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">line</span> <span class="o">===</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
        
        <span class="kd">var</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^([^:]+):\s*(.*)/</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">m</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">toLowerCase</span><span class="p">(),</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">m</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="nx">headers</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">((</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span> <span class="o">&amp;&amp;</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">headers</span><span class="p">[</span><span class="nx">key</span><span class="p">]))</span>
                <span class="o">||</span> <span class="nx">headers</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">headers</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">headers</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">headers</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span> <span class="nx">value</span> <span class="p">];</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="nx">headers</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="nx">headers</span><span class="p">[</span><span class="nx">line</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">headers</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">Response</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getHeader</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">header</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">headers</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="nx">key</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()]</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">header</span><span class="p">)</span> <span class="k">return</span> <span class="nx">header</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-157" id="section-157">&#182;</a>
</div>
<p>Work around Mozilla bug #608735 [<a href='https://bugzil.la/608735'>https://bugzil.la/608735</a>], which causes
getAllResponseHeaders() to return {} if the response is a CORS request.
xhr.getHeader still works correctly.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isSafeHeader</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">getResponseHeader</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">Response</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">handle</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="nx">capable</span><span class="p">.</span><span class="nx">status2</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">=</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">status</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">headers</span> <span class="o">=</span> <span class="nx">parseHeaders</span><span class="p">(</span><span class="nx">xhr</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">capable</span><span class="p">.</span><span class="nx">status2</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="nx">capable</span><span class="p">.</span><span class="nx">status2</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;ready&#39;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">capable</span><span class="p">.</span><span class="nx">streaming</span> <span class="o">&amp;&amp;</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">=</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">status</span><span class="p">;</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">headers</span> <span class="o">=</span> <span class="nx">parseHeaders</span><span class="p">(</span><span class="nx">xhr</span><span class="p">);</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;ready&#39;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{}</span>
        
        <span class="k">try</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">write</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">capable</span><span class="p">.</span><span class="nx">streaming</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">=</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">status</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;ready&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">write</span><span class="p">();</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="nx">Response</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">write</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">offset</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">offset</span><span class="p">));</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">offset</span> <span class="o">=</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="p">});</span>

<span class="nx">require</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s2">&quot;/node_modules/http-browserify/lib/isSafeHeader.js&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span> <span class="nx">exports</span><span class="p">,</span> <span class="nx">__dirname</span><span class="p">,</span> <span class="nx">__filename</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-158" id="section-158">&#182;</a>
</div>
<p>Taken from <a href='http://dxr.mozilla.org/mozilla/mozilla-central/content/base/src/nsXMLHttpRequest.cpp.html'>http://dxr.mozilla.org/mozilla/mozilla-central/content/base/src/nsXMLHttpRequest.cpp.html</a></p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">var</span> <span class="nx">unsafeHeaders</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;accept-charset&quot;</span><span class="p">,</span>
    <span class="s2">&quot;accept-encoding&quot;</span><span class="p">,</span>
    <span class="s2">&quot;access-control-request-headers&quot;</span><span class="p">,</span>
    <span class="s2">&quot;access-control-request-method&quot;</span><span class="p">,</span>
    <span class="s2">&quot;connection&quot;</span><span class="p">,</span>
    <span class="s2">&quot;content-length&quot;</span><span class="p">,</span>
    <span class="s2">&quot;cookie&quot;</span><span class="p">,</span>
    <span class="s2">&quot;cookie2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;content-transfer-encoding&quot;</span><span class="p">,</span>
    <span class="s2">&quot;date&quot;</span><span class="p">,</span>
    <span class="s2">&quot;expect&quot;</span><span class="p">,</span>
    <span class="s2">&quot;host&quot;</span><span class="p">,</span>
    <span class="s2">&quot;keep-alive&quot;</span><span class="p">,</span>
    <span class="s2">&quot;origin&quot;</span><span class="p">,</span>
    <span class="s2">&quot;referer&quot;</span><span class="p">,</span>
    <span class="s2">&quot;set-cookie&quot;</span><span class="p">,</span>
    <span class="s2">&quot;te&quot;</span><span class="p">,</span>
    <span class="s2">&quot;trailer&quot;</span><span class="p">,</span>
    <span class="s2">&quot;transfer-encoding&quot;</span><span class="p">,</span>
    <span class="s2">&quot;upgrade&quot;</span><span class="p">,</span>
    <span class="s2">&quot;user-agent&quot;</span><span class="p">,</span>
    <span class="s2">&quot;via&quot;</span>
<span class="p">];</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">headerName</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">headerName</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">unsafeHeaders</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">headerName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">())</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="p">};</span>

<span class="p">});</span>

<span class="nx">require</span><span class="p">.</span><span class="nx">alias</span><span class="p">(</span><span class="s2">&quot;http-browserify&quot;</span><span class="p">,</span> <span class="s2">&quot;/node_modules/http&quot;</span><span class="p">);</span>

<span class="nx">require</span><span class="p">.</span><span class="nx">alias</span><span class="p">(</span><span class="s2">&quot;http-browserify&quot;</span><span class="p">,</span> <span class="s2">&quot;/node_modules/https&quot;</span><span class="p">);</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
